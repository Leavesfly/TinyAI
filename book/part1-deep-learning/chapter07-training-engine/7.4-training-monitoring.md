# 7.4 è®­ç»ƒç›‘æ§ï¼šæŸå¤±æ›²çº¿ä¸æŒ‡æ ‡å¯è§†åŒ–

> "ç›‘æ§æ˜¯è®­ç»ƒè¿‡ç¨‹çš„çœ¼ç›ï¼Œé€šè¿‡å®æ—¶è§‚å¯ŸæŸå¤±æ›²çº¿å’Œæ€§èƒ½æŒ‡æ ‡ï¼Œæˆ‘ä»¬èƒ½å¤ŸåŠæ—¶å‘ç°é—®é¢˜ã€è°ƒæ•´ç­–ç•¥ï¼Œç¡®ä¿æ¨¡å‹æœç€æ­£ç¡®çš„æ–¹å‘å‰è¿›ã€‚"

è®­ç»ƒç›‘æ§æ˜¯æ·±åº¦å­¦ä¹ é¡¹ç›®æˆåŠŸçš„å…³é”®ç¯èŠ‚ã€‚é€šè¿‡å®æ—¶æ”¶é›†å’Œå¯è§†åŒ–è®­ç»ƒè¿‡ç¨‹ä¸­çš„å„ç§æŒ‡æ ‡ï¼Œæˆ‘ä»¬èƒ½å¤Ÿï¼šåŠæ—¶å‘ç°è¿‡æ‹Ÿåˆã€æ¬ æ‹Ÿåˆç­‰é—®é¢˜ï¼Œè°ƒæ•´è¶…å‚æ•°ï¼Œè¯„ä¼°æ¨¡å‹æ€§èƒ½ï¼Œåšå‡ºè®­ç»ƒç­–ç•¥å†³ç­–ã€‚æœ¬èŠ‚å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨TinyAIæ¡†æ¶ä¸­æ„å»ºå®Œæ•´çš„è®­ç»ƒç›‘æ§ç³»ç»Ÿã€‚

## 7.4.1 è®­ç»ƒç›‘æ§ç³»ç»Ÿæ¶æ„

### ç›‘æ§ç³»ç»Ÿè®¾è®¡åŸåˆ™

```mermaid
graph TB
    A[è®­ç»ƒè¿‡ç¨‹] --> B[æŒ‡æ ‡æ”¶é›†å™¨]
    B --> C[å®æ—¶ç›‘æ§]
    B --> D[å†å²è®°å½•]
    B --> E[å¯è§†åŒ–å±•ç¤º]
    C --> F[å¼‚å¸¸æ£€æµ‹]
    D --> G[è¶‹åŠ¿åˆ†æ]
    E --> H[å†³ç­–æ”¯æŒ]
```

### æ ¸å¿ƒç›‘æ§ç»„ä»¶

åŸºäºTinyAIç°æœ‰çš„Monitorç±»ï¼Œæˆ‘ä»¬æ¥æ‰©å±•ä¸€ä¸ªæ›´å¼ºå¤§çš„ç›‘æ§ç³»ç»Ÿï¼š

```java
/**
 * å¢å¼ºå‹è®­ç»ƒç›‘æ§å™¨
 * 
 * æä¾›å…¨é¢çš„è®­ç»ƒè¿‡ç¨‹ç›‘æ§ï¼ŒåŒ…æ‹¬æŸå¤±ã€å‡†ç¡®ç‡ã€å­¦ä¹ ç‡ã€æ¢¯åº¦ç­‰æŒ‡æ ‡
 */
public class EnhancedMonitor extends Monitor {
    
    // æ‰©å±•çš„ç›‘æ§æŒ‡æ ‡
    private List<Float> learningRateHistory;      // å­¦ä¹ ç‡å†å²
    private List<Float> gradientNormHistory;      // æ¢¯åº¦èŒƒæ•°å†å²
    private List<Integer> epochDurationHistory;   // æ¯è½®è®­ç»ƒæ—¶é—´
    private List<Float> memoryUsageHistory;       // å†…å­˜ä½¿ç”¨å†å²
    
    // éªŒè¯é›†æŒ‡æ ‡
    private List<Float> valLossHistory;           // éªŒè¯é›†æŸå¤±
    private List<Float> valAccuracyHistory;       // éªŒè¯é›†å‡†ç¡®ç‡
    
    // å®æ—¶ç›‘æ§é…ç½®
    private boolean enableRealTimeVisualization = true;
    private int visualizationUpdateInterval = 10;  // æ¯10ä¸ªepochæ›´æ–°ä¸€æ¬¡å¯è§†åŒ–
    
    // å¼‚å¸¸æ£€æµ‹
    private float lossAnomalyThreshold = 10.0f;   // æŸå¤±å¼‚å¸¸é˜ˆå€¼
    private float gradientAnomalyThreshold = 100.0f; // æ¢¯åº¦å¼‚å¸¸é˜ˆå€¼
    
    /**
     * æ„é€ å‡½æ•°
     */
    public EnhancedMonitor(String logFilePath) {
        super(logFilePath);
        initializeExtendedMetrics();
    }
    
    public EnhancedMonitor() {
        super();
        initializeExtendedMetrics();
    }
    
    private void initializeExtendedMetrics() {
        this.learningRateHistory = new ArrayList<>();
        this.gradientNormHistory = new ArrayList<>();
        this.epochDurationHistory = new ArrayList<>();
        this.memoryUsageHistory = new ArrayList<>();
        this.valLossHistory = new ArrayList<>();
        this.valAccuracyHistory = new ArrayList<>();
    }
    
    /**
     * æ”¶é›†å­¦ä¹ ç‡ä¿¡æ¯
     */
    public void collectLearningRate(float learningRate) {
        learningRateHistory.add(learningRate);
    }
    
    /**
     * æ”¶é›†æ¢¯åº¦ä¿¡æ¯
     */
    public void collectGradientNorm(float gradientNorm) {
        gradientNormHistory.add(gradientNorm);
        
        // æ¢¯åº¦å¼‚å¸¸æ£€æµ‹
        if (gradientNorm > gradientAnomalyThreshold) {
            System.err.printf("âš ï¸ æ¢¯åº¦å¼‚å¸¸: %.2f (é˜ˆå€¼: %.2f)\n", 
                             gradientNorm, gradientAnomalyThreshold);
        }
    }
    
    /**
     * æ”¶é›†å†…å­˜ä½¿ç”¨ä¿¡æ¯
     */
    public void collectMemoryUsage() {
        Runtime runtime = Runtime.getRuntime();
        long totalMemory = runtime.totalMemory();
        long freeMemory = runtime.freeMemory();
        float usedMemoryMB = (totalMemory - freeMemory) / 1024.0f / 1024.0f;
        
        memoryUsageHistory.add(usedMemoryMB);
    }
    
    /**
     * æ”¶é›†éªŒè¯é›†æŒ‡æ ‡
     */
    public void collectValidationMetrics(float valLoss, float valAccuracy) {
        valLossHistory.add(valLoss);
        valAccuracyHistory.add(valAccuracy);
    }
    
    /**
     * æ‰©å±•çš„ä¿¡æ¯æ‰“å°
     */
    @Override
    public void printTrainInfo() {
        super.printTrainInfo();
        
        // æ‰“å°æ‰©å±•ä¿¡æ¯
        if (!learningRateHistory.isEmpty() && learningRateHistory.size() > index) {
            System.out.printf("    å­¦ä¹ ç‡: %.6f", learningRateHistory.get(index));
        }
        
        if (!gradientNormHistory.isEmpty() && gradientNormHistory.size() > index) {
            System.out.printf(", æ¢¯åº¦èŒƒæ•°: %.4f", gradientNormHistory.get(index));
        }
        
        if (!memoryUsageHistory.isEmpty() && memoryUsageHistory.size() > index) {
            System.out.printf(", å†…å­˜: %.1fMB", memoryUsageHistory.get(index));
        }
        
        System.out.println();
    }
    
    /**
     * æ‰“å°éªŒè¯é›†ä¿¡æ¯
     */
    public void printValidationInfo() {
        if (!valLossHistory.isEmpty() && valLossHistory.size() > index) {
            System.out.printf("    éªŒè¯é›† - æŸå¤±: %.6f", valLossHistory.get(index));
        }
        
        if (!valAccuracyHistory.isEmpty() && valAccuracyHistory.size() > index) {
            System.out.printf(", å‡†ç¡®ç‡: %.4f", valAccuracyHistory.get(index));
        }
        
        System.out.println();
    }
    
    /**
     * å¼‚å¸¸æ£€æµ‹
     */
    public boolean detectAnomalies() {
        if (lossList.isEmpty()) return false;
        
        float currentLoss = lossList.get(lossList.size() - 1);
        
        // æ£€æµ‹æŸå¤±å¼‚å¸¸
        if (Float.isNaN(currentLoss) || Float.isInfinite(currentLoss) || 
            currentLoss > lossAnomalyThreshold) {
            System.err.printf("âŒ æŸå¤±å¼‚å¸¸æ£€æµ‹: %.6f\n", currentLoss);
            return true;
        }
        
        // æ£€æµ‹æŸå¤±çˆ†ç‚¸
        if (lossList.size() > 1) {
            float prevLoss = lossList.get(lossList.size() - 2);
            if (currentLoss > prevLoss * 2.0f && currentLoss > 1.0f) {
                System.err.printf("âŒ æŸå¤±çˆ†ç‚¸æ£€æµ‹: %.6f -> %.6f\n", prevLoss, currentLoss);
                return true;
            }
        }
        
        return false;
    }
}
```

## 7.4.2 æŒ‡æ ‡å¯è§†åŒ–ç³»ç»Ÿ

### å®æ—¶æŸå¤±æ›²çº¿

```java
/**
 * è®­ç»ƒå¯è§†åŒ–å™¨
 * 
 * è´Ÿè´£ç”Ÿæˆå„ç§è®­ç»ƒè¿‡ç¨‹çš„å¯è§†åŒ–å›¾è¡¨
 */
public class TrainingVisualizer {
    
    private Plot plot;
    private boolean realTimeMode;
    
    public TrainingVisualizer(boolean realTimeMode) {
        this.plot = new Plot();
        this.realTimeMode = realTimeMode;
    }
    
    /**
     * ç»˜åˆ¶æŸå¤±æ›²çº¿
     */
    public void plotLossCurves(EnhancedMonitor monitor) {
        List<Float> trainLoss = monitor.getLossList();
        List<Float> valLoss = monitor.getValLossList();
        
        if (!trainLoss.isEmpty()) {
            float[] epochs = generateEpochArray(trainLoss.size());
            float[] lossArray = listToArray(trainLoss);
            
            plot.line(epochs, lossArray, "è®­ç»ƒæŸå¤±");
        }
        
        if (!valLoss.isEmpty()) {
            float[] epochs = generateEpochArray(valLoss.size());
            float[] valLossArray = listToArray(valLoss);
            
            plot.line(epochs, valLossArray, "éªŒè¯æŸå¤±");
        }
        
        plot.xlabel("Epoch");
        plot.ylabel("Loss");
        plot.title("æŸå¤±æ›²çº¿");
        plot.legend();
        plot.show();
    }
    
    /**
     * ç»˜åˆ¶å‡†ç¡®ç‡æ›²çº¿
     */
    public void plotAccuracyCurves(EnhancedMonitor monitor) {
        List<Float> trainAcc = monitor.getAccuracyList();
        List<Float> valAcc = monitor.getValAccuracyList();
        
        if (!trainAcc.isEmpty()) {
            float[] epochs = generateEpochArray(trainAcc.size());
            float[] accArray = listToArray(trainAcc);
            
            plot.line(epochs, accArray, "è®­ç»ƒå‡†ç¡®ç‡");
        }
        
        if (!valAcc.isEmpty()) {
            float[] epochs = generateEpochArray(valAcc.size());
            float[] valAccArray = listToArray(valAcc);
            
            plot.line(epochs, valAccArray, "éªŒè¯å‡†ç¡®ç‡");
        }
        
        plot.xlabel("Epoch");
        plot.ylabel("Accuracy");
        plot.title("å‡†ç¡®ç‡æ›²çº¿");
        plot.legend();
        plot.show();
    }
    
    /**
     * ç»˜åˆ¶å­¦ä¹ ç‡æ›²çº¿
     */
    public void plotLearningRate(EnhancedMonitor monitor) {
        List<Float> lrHistory = monitor.getLearningRateHistory();
        
        if (!lrHistory.isEmpty()) {
            float[] epochs = generateEpochArray(lrHistory.size());
            float[] lrArray = listToArray(lrHistory);
            
            plot.line(epochs, lrArray, "å­¦ä¹ ç‡");
            plot.xlabel("Epoch");
            plot.ylabel("Learning Rate");
            plot.title("å­¦ä¹ ç‡å˜åŒ–");
            plot.yscale("log"); // ä½¿ç”¨å¯¹æ•°åæ ‡
            plot.show();
        }
    }
    
    /**
     * ç»˜åˆ¶æ¢¯åº¦èŒƒæ•°æ›²çº¿
     */
    public void plotGradientNorm(EnhancedMonitor monitor) {
        List<Float> gradNorm = monitor.getGradientNormHistory();
        
        if (!gradNorm.isEmpty()) {
            float[] epochs = generateEpochArray(gradNorm.size());
            float[] gradArray = listToArray(gradNorm);
            
            plot.line(epochs, gradArray, "æ¢¯åº¦èŒƒæ•°");
            plot.xlabel("Epoch");
            plot.ylabel("Gradient Norm");
            plot.title("æ¢¯åº¦èŒƒæ•°å˜åŒ–");
            plot.show();
        }
    }
    
    /**
     * ç”Ÿæˆç»¼åˆç›‘æ§ä»ªè¡¨æ¿
     */
    public void generateDashboard(EnhancedMonitor monitor) {
        System.out.println("ç”Ÿæˆè®­ç»ƒç›‘æ§ä»ªè¡¨æ¿...");
        
        // åˆ›å»ºå­å›¾å¸ƒå±€
        plot.subplot(2, 2, 1);
        plotLossCurves(monitor);
        
        plot.subplot(2, 2, 2);
        plotAccuracyCurves(monitor);
        
        plot.subplot(2, 2, 3);
        plotLearningRate(monitor);
        
        plot.subplot(2, 2, 4);
        plotGradientNorm(monitor);
        
        plot.suptitle("è®­ç»ƒç›‘æ§ä»ªè¡¨æ¿");
        plot.show();
    }
    
    // è¾…åŠ©æ–¹æ³•
    private float[] generateEpochArray(int size) {
        float[] epochs = new float[size];
        for (int i = 0; i < size; i++) {
            epochs[i] = i + 1;
        }
        return epochs;
    }
    
    private float[] listToArray(List<Float> list) {
        return list.stream().mapToDouble(Float::doubleValue).toArray();
    }
}
```

## 7.4.3 æ—©åœæœºåˆ¶

```java
/**
 * æ—©åœæ§åˆ¶å™¨
 * 
 * åŸºäºéªŒè¯é›†æŒ‡æ ‡å®ç°æ—©åœæœºåˆ¶ï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆ
 */
public class EarlyStopping {
    
    private float patience;              // å®¹å¿è½®æ•°
    private float minDelta;             // æœ€å°æ”¹å–„é˜ˆå€¼
    private String monitorMetric;       // ç›‘æ§çš„æŒ‡æ ‡åç§°
    private boolean restoreBestWeights; // æ˜¯å¦æ¢å¤æœ€ä½³æƒé‡
    
    private float bestScore;
    private int waitCount;
    private int bestEpoch;
    private boolean stopped;
    
    // æ¨¡å‹çŠ¶æ€ä¿å­˜ï¼ˆç®€åŒ–å®ç°ï¼‰
    private Map<String, Object> bestModelState;
    
    /**
     * æ„é€ å‡½æ•°
     */
    public EarlyStopping(float patience, float minDelta, String monitorMetric, 
                        boolean restoreBestWeights) {
        this.patience = patience;
        this.minDelta = minDelta;
        this.monitorMetric = monitorMetric;
        this.restoreBestWeights = restoreBestWeights;
        
        this.bestScore = Float.MAX_VALUE; // å‡è®¾ç›‘æ§æŸå¤±ï¼Œè¶Šå°è¶Šå¥½
        this.waitCount = 0;
        this.bestEpoch = 0;
        this.stopped = false;
        this.bestModelState = new HashMap<>();
        
        System.out.printf("æ—©åœæœºåˆ¶å¯ç”¨: patience=%.0f, min_delta=%.6f, metric=%s\n",
                         patience, minDelta, monitorMetric);
    }
    
    /**
     * æ›´æ–°ç›‘æ§æŒ‡æ ‡
     */
    public boolean update(float currentScore, int currentEpoch, Model model) {
        boolean improved = false;
        
        if (currentScore < bestScore - minDelta) {
            // æŒ‡æ ‡æœ‰æ”¹å–„
            bestScore = currentScore;
            bestEpoch = currentEpoch;
            waitCount = 0;
            improved = true;
            
            // ä¿å­˜æœ€ä½³æ¨¡å‹çŠ¶æ€
            if (restoreBestWeights) {
                saveModelState(model);
            }
            
            System.out.printf("âœ… æœ€ä½³%sæ›´æ–°: %.6f (Epoch %d)\n", 
                             monitorMetric, bestScore, bestEpoch + 1);
        } else {
            // æŒ‡æ ‡æ²¡æœ‰æ”¹å–„
            waitCount++;
            System.out.printf("â³ %sæœªæ”¹å–„: %.6f (ç­‰å¾… %d/%.0f)\n", 
                             monitorMetric, currentScore, waitCount, patience);
        }
        
        // æ£€æŸ¥æ˜¯å¦è§¦å‘æ—©åœ
        if (waitCount >= patience) {
            stopped = true;
            System.out.printf("ğŸ›‘ æ—©åœè§¦å‘! æœ€ä½³%s: %.6f (Epoch %d)\n", 
                             monitorMetric, bestScore, bestEpoch + 1);
            
            // æ¢å¤æœ€ä½³æƒé‡
            if (restoreBestWeights) {
                restoreModelState(model);
                System.out.println("ğŸ“¥ å·²æ¢å¤æœ€ä½³æ¨¡å‹æƒé‡");
            }
        }
        
        return improved;
    }
    
    /**
     * æ£€æŸ¥æ˜¯å¦åº”è¯¥åœæ­¢è®­ç»ƒ
     */
    public boolean shouldStop() {
        return stopped;
    }
    
    /**
     * è·å–æ—©åœç»Ÿè®¡ä¿¡æ¯
     */
    public void printStats() {
        System.out.println("\n=== æ—©åœç»Ÿè®¡ ===");
        System.out.printf("æœ€ä½³%s: %.6f\n", monitorMetric, bestScore);
        System.out.printf("æœ€ä½³è½®æ¬¡: %d\n", bestEpoch + 1);
        System.out.printf("ç­‰å¾…è½®æ•°: %d/%.0f\n", waitCount, patience);
        System.out.printf("æ˜¯å¦åœæ­¢: %s\n", stopped ? "æ˜¯" : "å¦");
    }
    
    // ç®€åŒ–çš„æ¨¡å‹çŠ¶æ€ä¿å­˜å’Œæ¢å¤
    private void saveModelState(Model model) {
        // è¿™é‡Œåº”è¯¥å®ç°æ¨¡å‹å‚æ•°çš„æ·±æ‹·è´
        // ç®€åŒ–å®ç°
        bestModelState.put("saved_epoch", bestEpoch);
        System.out.println("ğŸ“¤ æœ€ä½³æ¨¡å‹çŠ¶æ€å·²ä¿å­˜");
    }
    
    private void restoreModelState(Model model) {
        // è¿™é‡Œåº”è¯¥å®ç°æ¨¡å‹å‚æ•°çš„æ¢å¤
        // ç®€åŒ–å®ç°
        System.out.println("ğŸ“¥ æœ€ä½³æ¨¡å‹çŠ¶æ€å·²æ¢å¤");
    }
}
```

## 7.4.4 é›†æˆç›‘æ§çš„è®­ç»ƒå™¨

```java
/**
 * å¸¦ç›‘æ§çš„è®­ç»ƒå™¨
 * 
 * é›†æˆäº†å®Œæ•´ç›‘æ§åŠŸèƒ½çš„è®­ç»ƒå™¨
 */
public class MonitoredTrainer extends Trainer {
    
    private EnhancedMonitor enhancedMonitor;
    private TrainingVisualizer visualizer;
    private EarlyStopping earlyStopping;
    private LRScheduler lrScheduler;
    
    // ç›‘æ§é…ç½®
    private boolean enableVisualization = true;
    private int visualizationInterval = 10;
    private boolean enableEarlyStopping = false;
    
    /**
     * æ„é€ å‡½æ•°
     */
    public MonitoredTrainer(int maxEpoch, String logFile) {
        super(maxEpoch, new EnhancedMonitor(logFile), null);
        this.enhancedMonitor = (EnhancedMonitor) monitor;
        this.visualizer = new TrainingVisualizer(true);
    }
    
    /**
     * å¯ç”¨æ—©åœ
     */
    public MonitoredTrainer enableEarlyStopping(float patience, float minDelta) {
        this.earlyStopping = new EarlyStopping(patience, minDelta, "val_loss", true);
        this.enableEarlyStopping = true;
        return this;
    }
    
    /**
     * è®¾ç½®å­¦ä¹ ç‡è°ƒåº¦å™¨
     */
    public MonitoredTrainer setLRScheduler(LRScheduler scheduler) {
        this.lrScheduler = scheduler;
        return this;
    }
    
    /**
     * é‡å†™è®­ç»ƒæ–¹æ³•ï¼Œæ·»åŠ ç›‘æ§åŠŸèƒ½
     */
    @Override
    public TrainingResult train(boolean verbose) {
        System.out.println("ğŸš€ å¼€å§‹ç›‘æ§è®­ç»ƒ...");
        
        TrainingResult result = null;
        
        try {
            for (int epoch = 0; epoch < maxEpoch; epoch++) {
                // å¼€å§‹æ–°çš„epoch
                enhancedMonitor.startNewEpoch(epoch);
                
                // è®­ç»ƒä¸€ä¸ªepoch
                float epochLoss = trainOneEpochWithMonitoring(epoch, verbose);
                
                // æ”¶é›†å­¦ä¹ ç‡ä¿¡æ¯
                if (lrScheduler != null) {
                    lrScheduler.step();
                    enhancedMonitor.collectLearningRate(lrScheduler.getCurrentLearningRate());
                }
                
                // æ”¶é›†å…¶ä»–ç›‘æ§ä¿¡æ¯
                collectTrainingMetrics(epochLoss);
                
                // éªŒè¯é›†è¯„ä¼°
                float valLoss = 0.0f, valAccuracy = 0.0f;
                if (evaluator != null) {
                    valAccuracy = evaluator.evaluate();
                    // å‡è®¾èƒ½è·å–éªŒè¯æŸå¤±
                    valLoss = calculateValidationLoss();
                    enhancedMonitor.collectValidationMetrics(valLoss, valAccuracy);
                }
                
                // ç»“æŸepoch
                enhancedMonitor.endEpoch();
                enhancedMonitor.printTrainInfo();
                enhancedMonitor.printValidationInfo();
                
                // å¼‚å¸¸æ£€æµ‹
                if (enhancedMonitor.detectAnomalies()) {
                    System.err.println("æ£€æµ‹åˆ°è®­ç»ƒå¼‚å¸¸ï¼Œå»ºè®®æ£€æŸ¥è¶…å‚æ•°è®¾ç½®");
                }
                
                // æ—©åœæ£€æŸ¥
                if (enableEarlyStopping && earlyStopping != null) {
                    earlyStopping.update(valLoss, epoch, model);
                    if (earlyStopping.shouldStop()) {
                        break;
                    }
                }
                
                // å®šæœŸå¯è§†åŒ–
                if (enableVisualization && epoch % visualizationInterval == 0) {
                    updateVisualization();
                }
            }
            
            // ç”Ÿæˆæœ€ç»ˆç»“æœ
            result = generateFinalResult();
            
        } catch (Exception e) {
            System.err.println("è®­ç»ƒè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: " + e.getMessage());
            throw new RuntimeException("ç›‘æ§è®­ç»ƒå¤±è´¥", e);
        } finally {
            // ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
            generateFinalReport();
        }
        
        return result;
    }
    
    /**
     * æ”¶é›†è®­ç»ƒæŒ‡æ ‡
     */
    private void collectTrainingMetrics(float epochLoss) {
        // æ”¶é›†æ¢¯åº¦èŒƒæ•°
        float gradientNorm = calculateGradientNorm();
        enhancedMonitor.collectGradientNorm(gradientNorm);
        
        // æ”¶é›†å†…å­˜ä½¿ç”¨
        enhancedMonitor.collectMemoryUsage();
        
        // æ”¶é›†æŸå¤±
        enhancedMonitor.collectInfo(epochLoss);
    }
    
    /**
     * è®¡ç®—æ¢¯åº¦èŒƒæ•°
     */
    private float calculateGradientNorm() {
        float totalNorm = 0.0f;
        int paramCount = 0;
        
        Map<String, Parameter> params = model.getAllParams();
        for (Parameter param : params.values()) {
            if (param.getGrad() != null) {
                NdArray grad = param.getGrad();
                totalNorm += grad.square().sum().getNumber().floatValue();
                paramCount++;
            }
        }
        
        return paramCount > 0 ? (float) Math.sqrt(totalNorm) : 0.0f;
    }
    
    /**
     * è®¡ç®—éªŒè¯æŸå¤±ï¼ˆç®€åŒ–å®ç°ï¼‰
     */
    private float calculateValidationLoss() {
        // è¿™é‡Œåº”è¯¥åœ¨éªŒè¯é›†ä¸Šè®¡ç®—æŸå¤±
        return 0.5f; // ç®€åŒ–è¿”å›
    }
    
    /**
     * æ›´æ–°å¯è§†åŒ–
     */
    private void updateVisualization() {
        if (visualizer != null) {
            visualizer.plotLossCurves(enhancedMonitor);
        }
    }
    
    /**
     * ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
     */
    private void generateFinalReport() {
        System.out.println("\n" + "=".repeat(60));
        System.out.println("              è®­ç»ƒç›‘æ§æŠ¥å‘Š");
        System.out.println("=".repeat(60));
        
        // åŸºæœ¬ç»Ÿè®¡
        enhancedMonitor.printTrainInfo();
        
        // æ—©åœç»Ÿè®¡
        if (earlyStopping != null) {
            earlyStopping.printStats();
        }
        
        // ç”Ÿæˆå®Œæ•´ä»ªè¡¨æ¿
        if (enableVisualization) {
            visualizer.generateDashboard(enhancedMonitor);
        }
        
        System.out.println("=".repeat(60));
    }
}
```

## 7.4.5 ç›‘æ§åº”ç”¨ç¤ºä¾‹

```java
/**
 * è®­ç»ƒç›‘æ§åº”ç”¨ç¤ºä¾‹
 */
public class MonitoringExample {
    
    public static void main(String[] args) {
        System.out.println("=== è®­ç»ƒç›‘æ§ç³»ç»Ÿæ¼”ç¤º ===\n");
        
        // åˆ›å»ºæ•°æ®é›†å’Œæ¨¡å‹
        DataSet dataSet = new MnistDataSet(32);
        Model model = createModel();
        
        // åˆ›å»ºä¼˜åŒ–å™¨å’Œå­¦ä¹ ç‡è°ƒåº¦å™¨
        AdamOptimizer optimizer = new AdamOptimizer(model, 0.001f);
        CosineAnnealingLRScheduler lrScheduler = new CosineAnnealingLRScheduler(
            optimizer, 0.001f, 0.00001f, 1000);
        
        // åˆ›å»ºå¸¦ç›‘æ§çš„è®­ç»ƒå™¨
        MonitoredTrainer trainer = new MonitoredTrainer(50, "training_monitor.log");
        trainer.setLRScheduler(lrScheduler)
               .enableEarlyStopping(10, 0.001f);
        
        // åˆå§‹åŒ–å¹¶å¼€å§‹è®­ç»ƒ
        Loss loss = new SoftmaxCrossEntropy();
        Evaluator evaluator = new AccuracyEval(new Classify(), model, dataSet);
        
        trainer.init(dataSet, model, loss, optimizer);
        trainer.setEvaluator(evaluator);
        
        // å¼€å§‹ç›‘æ§è®­ç»ƒ
        TrainingResult result = trainer.train(true);
        
        System.out.println("è®­ç»ƒå®Œæˆï¼ç›‘æ§æŠ¥å‘Šå·²ç”Ÿæˆã€‚");
    }
    
    private static Model createModel() {
        Block mlpBlock = new MlpBlock("mnist_monitor", 32, 
                                     Config.ActiveFunc.ReLU, 
                                     784, 128, 64, 10);
        return new Model("MonitoredMNIST", mlpBlock);
    }
}
```

## æœ¬èŠ‚æ€»ç»“

æœ¬èŠ‚æ„å»ºäº†ä¸€ä¸ªå®Œæ•´çš„è®­ç»ƒç›‘æ§ç³»ç»Ÿï¼ŒåŒ…æ‹¬ï¼š

1. **å¢å¼ºç›‘æ§å™¨**ï¼šæ‰©å±•äº†æŸå¤±ã€å‡†ç¡®ç‡ã€å­¦ä¹ ç‡ã€æ¢¯åº¦ç­‰æŒ‡æ ‡çš„æ”¶é›†
2. **å¯è§†åŒ–ç³»ç»Ÿ**ï¼šæä¾›å®æ—¶çš„æŸå¤±æ›²çº¿ã€å‡†ç¡®ç‡æ›²çº¿ç­‰å›¾è¡¨
3. **æ—©åœæœºåˆ¶**ï¼šåŸºäºéªŒè¯é›†æŒ‡æ ‡è‡ªåŠ¨åœæ­¢è®­ç»ƒï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆ
4. **å¼‚å¸¸æ£€æµ‹**ï¼šåŠæ—¶å‘ç°è®­ç»ƒè¿‡ç¨‹ä¸­çš„æ•°å€¼å¼‚å¸¸
5. **é›†æˆè®­ç»ƒå™¨**ï¼šå°†æ‰€æœ‰ç›‘æ§åŠŸèƒ½æ•´åˆåˆ°è®­ç»ƒæµç¨‹ä¸­

è‰¯å¥½çš„ç›‘æ§ç³»ç»Ÿèƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬ï¼š
- åŠæ—¶å‘ç°è®­ç»ƒé—®é¢˜
- ä¼˜åŒ–è¶…å‚æ•°è®¾ç½®
- é¿å…è¿‡æ‹Ÿåˆå’Œæ¬ æ‹Ÿåˆ
- æé«˜è®­ç»ƒæ•ˆç‡

åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨å¹¶è¡Œè®­ç»ƒæŠ€æœ¯ï¼Œè¿›ä¸€æ­¥æå‡è®­ç»ƒæ•ˆç‡ã€‚