# 15.5 æ¨ç†ä¼˜åŒ–ï¼šKVç¼“å­˜ä¸æ‰¹é‡æ¨ç†

> **è®¾è®¡æ€æƒ³**ï¼šæŒæ¡å¤§æ¨¡å‹æ¨ç†ä¼˜åŒ–çš„æ ¸å¿ƒæŠ€æœ¯ï¼Œç†è§£KVç¼“å­˜å’Œæ‰¹é‡æ¨ç†çš„å®ç°åŸç†

## æœ¬èŠ‚æ¦‚è¿°

**ç”Ÿæ´»ç±»æ¯”**ï¼šæƒ³è±¡ä¸€å®¶é¤å…çš„ç‚¹é¤ç³»ç»Ÿï¼š

**ä¼ ç»Ÿæ–¹å¼**ï¼š
- æ¯æ¬¡ä¸Šèœéƒ½é‡æ–°ç‚¹ä¸€éå‰é¢çš„æ‰€æœ‰èœ
- æ¯ä½å®¢äººå•ç‹¬ç‚¹èœï¼Œå•ç‹¬åš
- æ•ˆç‡æä½ï¼Œç­‰å¾…æ—¶é—´é•¿

**ä¼˜åŒ–å**ï¼š
- **KVç¼“å­˜**ï¼šè®°ä½å·²ç»ç‚¹è¿‡çš„èœï¼Œä¸é‡å¤ç‚¹
- **æ‰¹é‡æ¨ç†**ï¼šå¤šä½å®¢äººç‚¹ç›¸åŒçš„èœï¼Œä¸€èµ·åš
- **é‡åŒ–å‹ç¼©**ï¼šç”¨ç®€å•çš„èœåä»£æ›¿é•¿æè¿°

åœ¨å¤§è¯­è¨€æ¨¡å‹æ¨ç†ä¸­ï¼Œè¿™äº›ä¼˜åŒ–èƒ½å¸¦æ¥æƒŠäººçš„æ•ˆæœï¼š
âœ… **å“åº”é€Ÿåº¦**ï¼šæå‡10-50å€
âœ… **å†…å­˜å ç”¨**ï¼šå‡å°‘50-75%  
âœ… **ååé‡**ï¼šæå‡5-20å€

æœ¬èŠ‚å°†å¸¦ä½ æŒæ¡è¿™äº›è®©å¤§æ¨¡å‹â€œé£èµ·æ¥â€çš„å…³é”®æŠ€æœ¯ï¼

## å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬èŠ‚å­¦ä¹ åï¼Œä½ å°†ï¼š

- âœ… **æŒæ¡KVç¼“å­˜çš„åŸç†**ï¼šç†è§£æ³¨æ„åŠ›æœºåˆ¶ä¸­KVç¼“å­˜çš„ä¼˜åŒ–æœºåˆ¶
- âœ… **å­¦ä¼šæ‰¹é‡æ¨ç†çš„å®ç°**ï¼šæŒæ¡åŠ¨æ€æ‰¹å¤„ç†å’Œåºåˆ—æ‰“åŒ…æŠ€æœ¯
- âœ… **ç†è§£é‡åŒ–æŠ€æœ¯**ï¼šæŒæ¡INT8ã€FP16ç­‰æ¨ç†ä¼˜åŒ–æ–¹æ³•
- âœ… **å…·å¤‡æ¨ç†æœåŠ¡æ¶æ„è®¾è®¡èƒ½åŠ›**ï¼šèƒ½å¤Ÿè®¾è®¡é«˜æ€§èƒ½çš„æ¨¡å‹æ¨ç†ç³»ç»Ÿ
- âœ… **æŒæ¡æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯**ï¼šç†è§£æ¨ç†è¿‡ç¨‹ä¸­çš„å„ç§ä¼˜åŒ–ç­–ç•¥

## KVç¼“å­˜æŠ€æœ¯ï¼šé¿å…é‡å¤è®¡ç®—

### é—®é¢˜ï¼šè‡ªå›å½’ç”Ÿæˆçš„é‡å¤è®¡ç®—

**ç”Ÿæ´»ç±»æ¯”**ï¼šæƒ³è±¡ä½ åœ¨é€å­—é€å¥ç¿»è¯‘ä¸€ç¯‡æ–‡ç« ã€‚ä¼ ç»Ÿæ–¹æ³•æ˜¯ï¼š
- ç¿»è¯‘ç¬¬2å¥æ—¶ï¼ŒæŠŠç¬¬1å¥é‡æ–°ç¿»è¯‘ä¸€é
- ç¿»è¯‘ç¬¬3å¥æ—¶ï¼ŒæŠŠç¬¬1ã€2å¥éƒ½é‡æ–°ç¿»è¯‘ä¸€é
- ç¿»è¯‘ç¬¬100å¥æ—¶ï¼Œè¦é‡æ–°ç¿»è¯‘å‰99å¥ï¼

è¿™æ˜¾ç„¶å¾ˆæµªè´¹ã€‚èªæ˜çš„åšæ³•æ˜¯ï¼šæŠŠå·²ç¿»è¯‘çš„å¥å­è®°ä¸‹æ¥ï¼ˆç¼“å­˜ï¼‰ï¼Œæ–°å¥å­åªéœ€å‚è€ƒå·²æœ‰ç¿»è¯‘ã€‚

**åœ¨Transformerä¸­çš„ä½“ç°**ï¼š

```mermaid
graph LR
    A[ç”Ÿæˆç¬¬1ä¸ªè¯<br/>è®¡ç®—K1,V1] --> B[ç”Ÿæˆç¬¬2ä¸ªè¯<br/>é‡ç®—K1,V1<br/>è®¡ç®—K2,V2]
    B --> C[ç”Ÿæˆç¬¬3ä¸ªè¯<br/>é‡ç®—K1,V1,K2,V2<br/>è®¡ç®—K3,V3]
    C --> D[ç”Ÿæˆç¬¬100ä¸ªè¯<br/>é‡ç®—å‰99ä¸ªè¯çš„K,V<br/>è®¡ç®—K100,V100]
    
    style D fill:#fcc,stroke:#333
```

**KVç¼“å­˜æ–¹æ¡ˆ**ï¼š

```mermaid
graph LR
    A[ç”Ÿæˆç¬¬1ä¸ªè¯<br/>è®¡ç®—å¹¶ç¼“å­˜K1,V1] --> B[ç”Ÿæˆç¬¬2ä¸ªè¯<br/>è¯»å–K1,V1<br/>åªè®¡ç®—K2,V2]
    B --> C[ç”Ÿæˆç¬¬3ä¸ªè¯<br/>è¯»å–K1,V1,K2,V2<br/>åªè®¡ç®—K3,V3]
    C --> D[ç”Ÿæˆç¬¬100ä¸ªè¯<br/>è¯»å–ç¼“å­˜çš„K,V<br/>åªè®¡ç®—K100,V100]
    
    style D fill:#cfc,stroke:#333
```

### ç®€åŒ–å®ç°

```java
public class KVCache {
    private List<Variable> keyCache;    // ç¼“å­˜æ‰€æœ‰å±‚çš„K
    private List<Variable> valueCache;  // ç¼“å­˜æ‰€æœ‰å±‚çš„V
    private int maxLength;
    
    public void updateCache(int layerIdx, Variable newKeys, Variable newValues) {
        if (keyCache.get(layerIdx) == null) {
            // é¦–æ¬¡ï¼šç›´æ¥ä¿å­˜
            keyCache.set(layerIdx, newKeys);
            valueCache.set(layerIdx, newValues);
        } else {
            // åç»­ï¼šæ‹¼æ¥æ–°çš„K,Våˆ°ç¼“å­˜æœ«å°¾
            Variable existingKeys = keyCache.get(layerIdx);
            Variable existingValues = valueCache.get(layerIdx);
            
            keyCache.set(layerIdx, existingKeys.concat(newKeys, -2));
            valueCache.set(layerIdx, existingValues.concat(newValues, -2));
        }
    }
    
    public Variable getKeys(int layerIdx) {
        return keyCache.get(layerIdx);  // è¿”å›æ‰€æœ‰å†å²K
    }
}
```

**æ€§èƒ½æå‡**ï¼š
- âš¡ é€Ÿåº¦æå‡ï¼š10-50å€ï¼ˆåºåˆ—è¶Šé•¿æ•ˆæœè¶Šæ˜æ˜¾ï¼‰
- ğŸ’¾ å†…å­˜å¢åŠ ï¼šéœ€è¦é¢å¤–å­˜å‚¨K,Vç¼“å­˜
- ğŸ¯ é€‚ç”¨åœºæ™¯ï¼šæ–‡æœ¬ç”Ÿæˆã€å¯¹è¯ç³»ç»Ÿã€ä»£ç è¡¥å…¨
## æ‰¹é‡æ¨ç†æŠ€æœ¯ï¼šæå‡ååé‡

### åŠ¨æ€æ‰¹å¤„ç†

**ç”Ÿæ´»ç±»æ¯”**ï¼šæƒ³è±¡ä¸€ä¸ªé…’åº—çš„ç”µæ¢¯ï¼š

**æ–¹æ¡ˆAï¼šæ¯äººå•ç‹¬åç”µæ¢¯**
- ä¸€ä¸ªäººåä¸€æ¬¡ï¼Œç©ºé—´æµªè´¹
- ç­‰å¾…æ—¶é—´é•¿
- æ•ˆç‡æä½

**æ–¹æ¡ˆBï¼šå¤šäººä¸€èµ·å**
- ç­‰å‡ ä¸ªäººæˆ–ç­‰å‡ ç§’ï¼Œå‡‘æ»¡ä¸€èµ·èµ°
- ç©ºé—´åˆ©ç”¨ç‡é«˜
- æ¯å°æ—¶è¿è½½äººæ•°å¢åŠ 5-10å€

æ‰¹é‡æ¨ç†å°±æ˜¯æ–¹æ¡ˆBï¼Œå°†å¤šä¸ªè¯·æ±‚æ‰“åŒ…ä¸€èµ·å¤„ç†ã€‚

### ç®€åŒ–å®ç°

```java
public class DynamicBatcher {
    private Queue<InferenceRequest> requestQueue;  // è¯·æ±‚é˜Ÿåˆ—
    private int maxBatchSize;     // æœ€å¤§æ‰¹æ¬¡å¤§å°
    private int maxWaitTimeMs;    // æœ€å¤§ç­‰å¾…æ—¶é—´
    
    public CompletableFuture<Response> addRequest(InferenceRequest request) {
        CompletableFuture<Response> future = new CompletableFuture<>();
        request.setFuture(future);
        requestQueue.offer(request);
        
        // å®šæ—¶è§¦å‘æ‰¹å¤„ç†ï¼ˆé¿å…ç­‰å¾…è¿‡ä¹…ï¼‰
        scheduleBatchProcessing();
        
        return future;
    }
    
    private void processBatch() {
        List<InferenceRequest> batch = new ArrayList<>();
        
        // æ”¶é›†æ‰¹å¤„ç†è¯·æ±‚ï¼ˆæ»¡è¶³ä»»ä¸€æ¡ä»¶å°±æ‰§è¡Œï¼‰
        // 1. è¾¾åˆ°æœ€å¤§æ‰¹æ¬¡å¤§å°
        // 2. è¶…è¿‡æœ€å¤§ç­‰å¾…æ—¶é—´
        int batchSize = Math.min(maxBatchSize, requestQueue.size());
        for (int i = 0; i < batchSize; i++) {
            batch.add(requestQueue.poll());
        }
        
        if (!batch.isEmpty()) {
            // æ‰“åŒ…è¾“å…¥
            Variable batchedInput = packInputs(batch);
            
            // ä¸€æ¬¡æ‰§è¡Œ
            Variable outputs = model.forward(batchedInput);
            
            // è§£åŒ…è¾“å‡ºï¼Œåˆ†å‘ç»™å„è¯·æ±‚
            List<Variable> individualOutputs = unpackOutputs(outputs);
            for (int i = 0; i < batch.size(); i++) {
                batch.get(i).getFuture().complete(
                    new Response(individualOutputs.get(i))
                );
            }
        }
    }
}
```

**æ•ˆæœå¯¹æ¯”**ï¼š

| æŒ‡æ ‡ | å•ä¸ªå¤„ç† | æ‰¹é‡å¤„ç†(8) | æå‡ |
|------|----------|--------------|------|
| QPS | 10 | 60 | 6å€ |
| å»¶è¿Ÿ | 100ms | 120ms | +20% |
| GPUåˆ©ç”¨ç‡ | 20% | 85% | 4å€+ |


## é‡åŒ–æŠ€æœ¯ï¼šå‹ç¼©æ¨¡å‹ä½“ç§¯

**ç”Ÿæ´»ç±»æ¯”**ï¼šæƒ³è±¡ä½ åœ¨å‹ç¼©ç…§ç‰‡ï¼š

**æ–¹æ¡ˆAï¼šé«˜ç²¾åº¦å­˜å‚¨ï¼ˆFP32ï¼‰**
- æ¯ä¸ªåƒç´ ç”¨32ä½å­˜å‚¨é¢œè‰²
- æ–‡ä»¶å¾ˆå¤§ï¼š10MB
- è´¨é‡å®Œç¾ï¼Œä½†ä¼ è¾“æ…¢ã€å ç©ºé—´

**æ–¹æ¡ˆBï¼šå‹ç¼©å­˜å‚¨ï¼ˆINT8ï¼‰**
- æ¯ä¸ªåƒç´ ç”¨8ä½å­˜å‚¨é¢œè‰²
- æ–‡ä»¶ç¼©å°åˆ°2.5MBï¼ˆ4å€å‹ç¼©ï¼‰
- è´¨é‡ç•¥æœ‰æŸå¤±ï¼Œä½†è‚‰çœ¼éš¾è¾¨
- ä¼ è¾“å¿«ã€çœç©ºé—´

æ¨¡å‹é‡åŒ–å°±æ˜¯è¿™ä¸ªåŸç†ï¼šç”¨æ›´å°‘çš„ä½æ•°è¡¨ç¤ºæƒé‡ï¼Œæ¢å–é€Ÿåº¦å’Œå†…å­˜ä¼˜åŠ¿ã€‚

### é‡åŒ–æŠ€æœ¯å¯¹æ¯”

| ç²¾åº¦ç±»å‹ | å­˜å‚¨ä½æ•° | æ¨¡å‹å¤§å° | æ¨ç†é€Ÿåº¦ | ç²¾åº¦æŸå¤± | é€‚ç”¨åœºæ™¯ |
|----------|----------|----------|----------|----------|----------|
| FP32 | 32ä½ | 100% | 1x | æ—  | è®­ç»ƒã€é«˜ç²¾åº¦æ¨ç† |
| FP16 | 16ä½ | 50% | 2-3x | æå° | é€šç”¨æ¨ç† |
| INT8 | 8ä½ | 25% | 3-5x | å° | è¾¹ç¼˜è®¾å¤‡ã€ç§»åŠ¨ç«¯ |
| INT4 | 4ä½ | 12.5% | 5-8x | ä¸­ç­‰ | èµ„æºå—é™åœºæ™¯ |

### æ ¸å¿ƒå®ç°

```java
public class INT8Quantizer {
    public QuantizedTensor quantize(Variable tensor) {
        // æ­¥éª¤1ï¼šæ‰¾åˆ°æœ€å¤§ç»å¯¹å€¼
        float maxAbs = Math.max(
            Math.abs(tensor.max().getData().getFloat()),
            Math.abs(tensor.min().getData().getFloat())
        );
        
        // æ­¥éª¤2ï¼šè®¡ç®—ç¼©æ”¾å› å­ï¼ˆ127æ˜¯INT8çš„æœ€å¤§å€¼ï¼‰
        float scale = 127.0f / maxAbs;
        
        // æ­¥éª¤3ï¼šé‡åŒ–ï¼ˆFP32 â†’ INT8ï¼‰
        Variable quantized = tensor.mul(scale).round().clip(-128, 127);
        
        return new QuantizedTensor(quantized.getData().toByteArray(), scale);
    }
    
    public Variable dequantize(QuantizedTensor qt) {
        // åé‡åŒ–ï¼ˆINT8 â†’ FP32ï¼‰
        return new Variable(NdArray.of(qt.getData())).div(qt.getScale());
    }
}
```

**é‡åŒ–æµç¨‹å›¾**ï¼š

```mermaid
graph LR
    A[åŸå§‹æƒé‡<br/>FP32: 3.14159] --> B[è®¡ç®—ç¼©æ”¾å› å­<br/>scale=127/max]
    B --> C[ç¼©æ”¾å¹¶å–æ•´<br/>INT8: 112]
    C --> D[æ¨ç†è®¡ç®—<br/>INT8è¿ç®—]
    D --> E[åé‡åŒ–<br/>FP32: 3.12]
    
    style A fill:#fee,stroke:#333
    style C fill:#cfc,stroke:#333
    style E fill:#fee,stroke:#333
```

**å®é™…æ•ˆæœ**ï¼ˆä»¥LLaMA-7Bä¸ºä¾‹ï¼‰ï¼š
- ğŸ“¦ **æ¨¡å‹å¤§å°**ï¼š13GB â†’ 3.5GBï¼ˆINT8é‡åŒ–ï¼‰
- âš¡ **æ¨ç†é€Ÿåº¦**ï¼šæå‡2.5-4å€
- ğŸ“Š **ç²¾åº¦æŸå¤±**ï¼šå›°æƒ‘åº¦ä»…å¢åŠ 1-3%
- ğŸ’» **é€‚é…è®¾å¤‡**ï¼šæ™®é€šç¬”è®°æœ¬å³å¯è¿è¡Œ7Bæ¨¡å‹

## æ¨ç†æœåŠ¡æ¶æ„ï¼šæ„å»ºç”Ÿäº§çº§ç³»ç»Ÿ

**ç³»ç»Ÿæ¶æ„å›¾**ï¼š

```mermaid
graph TB
    subgraph å®¢æˆ·ç«¯å±‚
        A[Webå‰ç«¯]
        B[ç§»åŠ¨APP]
        C[APIè°ƒç”¨]
    end
    
    subgraph ç½‘å…³å±‚
        D[è´Ÿè½½å‡è¡¡]
        E[é€Ÿç‡é™åˆ¶]
        F[è®¤è¯é‰´æƒ]
    end
    
    subgraph æ¨ç†å±‚
        G[è¯·æ±‚é˜Ÿåˆ—]
        H[åŠ¨æ€æ‰¹å¤„ç†å™¨]
        I[KVç¼“å­˜ç®¡ç†]
        J[æ¨¡å‹æ¨ç†å¼•æ“]
    end
    
    subgraph ç›‘æ§å±‚
        K[æ€§èƒ½ç›‘æ§]
        L[æ—¥å¿—æ”¶é›†]
    end
    
    A --> D
    B --> D
    C --> D
    D --> E
    E --> F
    F --> G
    G --> H
    H --> I
    I --> J
    J --> K
    J --> L
    
    style J fill:#cfc,stroke:#333
    style H fill:#ffc,stroke:#333
    style I fill:#ffc,stroke:#333
```

### æ ¸å¿ƒæ¨ç†æ¥å£

```java
@RestController
@RequestMapping("/api/v1/inference")
public class InferenceController {
    @Autowired
    private DynamicBatcher batcher;
    
    @PostMapping("/generate")
    public ResponseEntity<StreamingResponseBody> generateText(
            @RequestBody GenerationRequest request) {
        
        // åˆ›å»ºæ¨ç†è¯·æ±‚å¹¶æ·»åŠ åˆ°æ‰¹å¤„ç†é˜Ÿåˆ—
        CompletableFuture<InferenceResponse> future = batcher.addRequest(
            new InferenceRequest(request.getPrompt(), request.getGenerationConfig())
        );
        
        // æµå¼è¿”å›ç»“æœ
        StreamingResponseBody responseBody = outputStream -> {
            String result = future.get().getResult();
            outputStream.write(result.getBytes(StandardCharsets.UTF_8));
            outputStream.flush();
        };
        
        return ResponseEntity.ok().contentType(MediaType.TEXT_PLAIN).body(responseBody);
    }
}
```

### ç¼“å­˜ç®¡ç†ç­–ç•¥

**ç”Ÿæ´»ç±»æ¯”**ï¼šæƒ³è±¡ä¸€ä¸ªå›¾ä¹¦é¦†çš„é˜…è§ˆå®¤ï¼š
- **æœ‰é™åº§ä½**ï¼šç¼“å­˜ç©ºé—´æœ‰é™ï¼Œä¸èƒ½æ— é™åˆ¶ä¿å­˜
- **çƒ­é—¨ä¹¦ç±**ï¼šæœ€è¿‘å¸¸è¯»çš„ä¹¦æ”¾åœ¨æ¡Œä¸Šï¼ˆLRUç­–ç•¥ï¼‰
- **å®šæ—¶æ•´ç†**ï¼šå®šæœŸæ¸…ç†é•¿æ—¶é—´æœªç”¨çš„ç¼“å­˜

```java
@Component
public class KVCacheManager {
    private Map<String, KVCache> sessionCaches = new ConcurrentHashMap<>();
    private LRUCacheEvictionPolicy evictionPolicy = new LRUCacheEvictionPolicy();
    
    public KVCache getOrCreateCache(String sessionId, ModelConfig config) {
        return sessionCaches.computeIfAbsent(sessionId, id -> 
            new KVCache(config.getNumLayers(), config.getMaxSeqLength())
        );
    }
    
    @Scheduled(fixedDelay = 60000)  // æ¯åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡
    public void cleanupExpiredCaches() {
        List<String> expired = evictionPolicy.getExpiredSessions(
            sessionCaches.keySet(), System.currentTimeMillis()
        );
        expired.forEach(this::releaseCache);
    }
}
```

**ç¼“å­˜ç­–ç•¥å¯¹æ¯”**ï¼š

| ç­–ç•¥ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| LRU | ç®€å•é«˜æ•ˆ | å¯èƒ½æ¸…ç†çƒ­ç‚¹æ•°æ® | é€šç”¨åœºæ™¯ |
| LFU | ä¿ç•™çƒ­ç‚¹ | å®ç°å¤æ‚ | é«˜é¢‘è®¿é—®åœºæ™¯ |
| TTL | å¯é¢„æµ‹ | å¯èƒ½æµªè´¹ç©ºé—´ | ä¼šè¯å‹åº”ç”¨ |
| æ··åˆç­–ç•¥ | æ•ˆæœæœ€ä¼˜ | å¤æ‚åº¦é«˜ | ç”Ÿäº§ç¯å¢ƒ |

## æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼šå…¨æ–¹ä½æå‡æ¨ç†æ•ˆç‡

### ä¼˜åŒ–æ£€æŸ¥æ¸…å•

**ç”Ÿæ´»ç±»æ¯”**ï¼šæƒ³è±¡ä¼˜åŒ–ä¸€å®¶é¤å…çš„æ•ˆç‡ï¼š

| ä¼˜åŒ–ç»´åº¦ | é¤å…ç±»æ¯” | æ¨¡å‹æ¨ç†ä¼˜åŒ– | é¢„æœŸæå‡ |
|----------|----------|--------------|----------|
| **è®¡ç®—ä¼˜åŒ–** | æå‡å¨å¸ˆæ‰‹é€Ÿ | KVç¼“å­˜ã€ç®—å­èåˆ | 10-50å€ |
| **å†…å­˜ä¼˜åŒ–** | å‡å°‘é£Ÿæå ç”¨ | é‡åŒ–ã€æ¢¯åº¦æ£€æŸ¥ç‚¹ | èŠ‚çœ50-75% |
| **å¹¶å‘ä¼˜åŒ–** | å¤šå•ä¸€èµ·åš | æ‰¹é‡æ¨ç†ã€å¼‚æ­¥å¤„ç† | 5-20å€åå |
| **ç¡¬ä»¶ä¼˜åŒ–** | å‡çº§ç‚‰ç¶ | GPUä¼˜åŒ–ã€TensorRT | 2-5å€ |
| **ç¼“å­˜ä¼˜åŒ–** | é¢„åˆ¶åŠæˆå“ | KVç¼“å­˜ã€ç»“æœç¼“å­˜ | æ˜¾è‘—é™ä½å»¶è¿Ÿ |

### æ ¸å¿ƒç›‘æ§æŒ‡æ ‡

```java
public class InferenceProfiler {
    public InferenceMetrics getMetrics() {
        double avgLatency = (double) totalInferenceTime / totalTokensProcessed;
        double throughput = (double) totalTokensProcessed / (totalInferenceTime / 1000.0);
        double cacheHitRate = (double) cacheHits / (cacheHits + cacheMisses);
        
        return new InferenceMetrics(avgLatency, throughput, cacheHitRate);
    }
}
```

**å…³é”®æŒ‡æ ‡è¯´æ˜**ï¼š

| æŒ‡æ ‡ | å«ä¹‰ | ä¼˜åŒ–ç›®æ ‡ | å½±å“å› ç´  |
|------|------|----------|----------|
| **å»¶è¿Ÿ(Latency)** | å•æ¬¡è¯·æ±‚å“åº”æ—¶é—´ | <100ms | æ¨¡å‹å¤§å°ã€æ‰¹æ¬¡å¤§å° |
| **åå(Throughput)** | æ¯ç§’å¤„ç†tokenæ•° | >1000 tokens/s | æ‰¹å¤„ç†ã€å¹¶è¡Œåº¦ |
| **ç¼“å­˜å‘½ä¸­ç‡** | KVç¼“å­˜åˆ©ç”¨ç‡ | >80% | ä¼šè¯é•¿åº¦ã€ç¼“å­˜ç­–ç•¥ |
| **GPUåˆ©ç”¨ç‡** | è®¡ç®—èµ„æºå ç”¨ | >70% | æ‰¹æ¬¡å¤§å°ã€æ¨¡å‹å¹¶è¡Œ |
| **å†…å­˜å ç”¨** | æ˜¾å­˜ä½¿ç”¨é‡ | å°½é‡ä½ | é‡åŒ–ã€KVç¼“å­˜å¤§å° |

### å®æˆ˜ä¼˜åŒ–å»ºè®®

**é’ˆå¯¹ä¸åŒåœºæ™¯çš„æœ€ä½³å®è·µ**ï¼š

#### åœºæ™¯1ï¼šå¯¹è¯ç³»ç»Ÿï¼ˆä½å»¶è¿Ÿä¼˜å…ˆï¼‰
```
âœ… å¯ç”¨KVç¼“å­˜ï¼ˆå¿…é¡»ï¼‰
âœ… FP16ç²¾åº¦ï¼ˆé€Ÿåº¦æå‡2xï¼Œç²¾åº¦æŸå¤±å°ï¼‰
âœ… å°æ‰¹æ¬¡å¤„ç†ï¼ˆbatch_size=1-4ï¼‰
âœ… é¢„åŠ è½½æ¨¡å‹åˆ°GPU
âŒ é¿å…INT8é‡åŒ–ï¼ˆç²¾åº¦è¦æ±‚é«˜ï¼‰
```

#### åœºæ™¯2ï¼šæ‰¹é‡æ–‡æœ¬å¤„ç†ï¼ˆååä¼˜å…ˆï¼‰
```
âœ… å¤§æ‰¹æ¬¡å¤„ç†ï¼ˆbatch_size=32-128ï¼‰
âœ… INT8é‡åŒ–ï¼ˆèŠ‚çœå†…å­˜ï¼Œæå‡ååï¼‰
âœ… åºåˆ—æ‰“åŒ…ï¼ˆå‡å°‘paddingæµªè´¹ï¼‰
âœ… å¼‚æ­¥å¤„ç†é˜Ÿåˆ—
âŒ å¯é€‚å½“ç‰ºç‰²å»¶è¿Ÿ
```

#### åœºæ™¯3ï¼šè¾¹ç¼˜è®¾å¤‡ï¼ˆèµ„æºå—é™ï¼‰
```
âœ… INT8æˆ–INT4é‡åŒ–ï¼ˆå¿…é¡»ï¼‰
âœ… æ¨¡å‹å‰ªæå’Œè’¸é¦
âœ… å°æ¨¡å‹ä¼˜å…ˆï¼ˆ7Bä»¥ä¸‹ï¼‰
âœ… CPUæ¨ç†ä¼˜åŒ–
âŒ é¿å…å¤§æ‰¹æ¬¡ï¼ˆå†…å­˜ä¸è¶³ï¼‰
```

### æ€§èƒ½è°ƒä¼˜æµç¨‹

```mermaid
graph TD
    A[æ€§èƒ½åˆ†æ] --> B{æ‰¾åˆ°ç“¶é¢ˆ}
    B -->|è®¡ç®—ç“¶é¢ˆ| C[ä¼˜åŒ–ç®—å­<br/>KVç¼“å­˜<br/>ç®—å­èåˆ]
    B -->|å†…å­˜ç“¶é¢ˆ| D[é‡åŒ–å‹ç¼©<br/>æ¢¯åº¦æ£€æŸ¥ç‚¹<br/>å‡å°æ‰¹æ¬¡]
    B -->|IOç“¶é¢ˆ| E[æ‰¹é‡å¤„ç†<br/>å¼‚æ­¥åŠ è½½<br/>é¢„å–æ•°æ®]
    C --> F[éªŒè¯æ•ˆæœ]
    D --> F
    E --> F
    F --> G{è¾¾åˆ°ç›®æ ‡?}
    G -->|å¦| A
    G -->|æ˜¯| H[éƒ¨ç½²ä¸Šçº¿]
    
    style H fill:#cfc,stroke:#333
```

## å®é™…åº”ç”¨æ¡ˆä¾‹ï¼šå¯¹è¯ç³»ç»Ÿä¼˜åŒ–

**å®Œæ•´åº”ç”¨æ¶æ„**ï¼š

```mermaid
graph TB
    subgraph ç”¨æˆ·è¯·æ±‚
        A[ç”¨æˆ·è¾“å…¥æ¶ˆæ¯]
    end
    
    subgraph æœåŠ¡å±‚
        B[APIç½‘å…³<br/>é€Ÿç‡é™åˆ¶]
        C[ChatbotService<br/>å¯¹è¯ç®¡ç†]
    end
    
    subgraph æ¨ç†å¼•æ“
        D[è·å–å†å²å¯¹è¯]
        E[æ„å»ºå®Œæ•´Prompt]
        F[ä»ç¼“å­˜è·å–KV]
        G[æ‰¹é‡æ¨ç†]
        H[æµå¼è¿”å›ç»“æœ]
    end
    
    A --> B
    B --> C
    C --> D
    D --> E
    E --> F
    F --> G
    G --> H
    H --> A
    
    style G fill:#cfc,stroke:#333
    style F fill:#ffc,stroke:#333
```

### æ ¸å¿ƒæœåŠ¡å®ç°

```java
@Service
public class ChatbotService {
    @Autowired
    private DynamicBatcher batcher;
    @Autowired
    private KVCacheManager cacheManager;
    
    public CompletableFuture<String> chat(String sessionId, String userInput) {
        // æ­¥éª¤1ï¼šæ„å»ºå¯¹è¯æç¤ºï¼ˆåŒ…å«å†å²å¯¹è¯ï¼‰
        String prompt = buildChatPrompt(getHistory(sessionId), userInput);
        
        // æ­¥éª¤2ï¼šè·å–è¯¥ä¼šè¯çš„KVç¼“å­˜ï¼ˆåŠ é€Ÿåç»­è½®æ¬¡ï¼‰
        KVCache kvCache = cacheManager.getOrCreateCache(sessionId, modelConfig);
        
        // æ­¥éª¤3ï¼šåˆ›å»ºæ¨ç†è¯·æ±‚å¹¶æäº¤åˆ°æ‰¹å¤„ç†é˜Ÿåˆ—
        GenerationConfig config = GenerationConfig.builder()
            .setMaxTokens(512)
            .setTemperature(0.7)
            .build();
        
        CompletableFuture<InferenceResponse> future = batcher.addRequest(
            new InferenceRequest(prompt, config, kvCache)
        );
        
        // æ­¥éª¤4ï¼šå¼‚æ­¥è¿”å›ç»“æœ
        return future.thenApply(response -> {
            updateHistory(sessionId, userInput, response.getResult());
            return response.getResult();
        });
    }
}
```

### å®é™…æ€§èƒ½æ•°æ®

**æŸå¯¹è¯ç³»ç»Ÿä¼˜åŒ–å‰åå¯¹æ¯”**ï¼ˆåŸºäºLLaMA-13Bæ¨¡å‹ï¼‰ï¼š

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡å¹…åº¦ |
|------|--------|--------|----------|
| **é¦–æ¬¡å“åº”å»¶è¿Ÿ** | 2.5ç§’ | 0.8ç§’ | **3.1å€** |
| **åç»­è½®æ¬¡å»¶è¿Ÿ** | 2.3ç§’ | 0.3ç§’ | **7.7å€** |
| **å¹¶å‘å¤„ç†èƒ½åŠ›** | 5 QPS | 45 QPS | **9å€** |
| **GPUå†…å­˜å ç”¨** | 24GB | 12GB | **èŠ‚çœ50%** |
| **å•å¡ååé‡** | 150 tokens/s | 1200 tokens/s | **8å€** |

**ä¼˜åŒ–æŠ€æœ¯ç»„åˆ**ï¼š
- âœ… KVç¼“å­˜ï¼ˆåç»­è½®æ¬¡åŠ é€Ÿ7å€ï¼‰
- âœ… FP16é‡åŒ–ï¼ˆå†…å­˜å‡åŠã€é€Ÿåº¦ç¿»å€ï¼‰
- âœ… æ‰¹é‡æ¨ç†ï¼ˆååæå‡8å€ï¼‰
- âœ… ç®—å­èåˆï¼ˆå‡å°‘kernelè°ƒç”¨ï¼‰

### APIç½‘å…³å®ç°

```java
@RestController
@RequestMapping("/api/chat")
public class ChatAPIController {
    @Autowired
    private ChatbotService chatbotService;
    @Autowired
    private RateLimiter rateLimiter;
    
    @PostMapping("/message")
    public ResponseEntity<StreamingResponseBody> sendMessage(
            @RequestHeader("X-Session-ID") String sessionId,
            @RequestBody ChatMessageRequest request) {
        
        // é€Ÿç‡é™åˆ¶ï¼ˆé˜²æ­¢æ»¥ç”¨ï¼‰
        if (!rateLimiter.tryAcquire(sessionId)) {
            return ResponseEntity.status(429).build();
        }
        
        // æ‰§è¡Œæ¨ç†
        CompletableFuture<String> chatFuture = chatbotService.chat(
            sessionId, request.getMessage()
        );
        
        // æµå¼è¿”å›ï¼ˆæå‡ç”¨æˆ·ä½“éªŒï¼‰
        StreamingResponseBody responseBody = outputStream -> {
            String response = chatFuture.get();
            outputStream.write(response.getBytes(StandardCharsets.UTF_8));
            outputStream.flush();
        };
        
        return ResponseEntity.ok().contentType(MediaType.TEXT_PLAIN).body(responseBody);
    }
}
```

**å…³é”®è®¾è®¡è¦ç‚¹**ï¼š
1. **é€Ÿç‡é™åˆ¶**ï¼šé˜²æ­¢å•ç”¨æˆ·å ç”¨è¿‡å¤šèµ„æº
2. **æµå¼å“åº”**ï¼šè¾¹ç”Ÿæˆè¾¹è¿”å›ï¼Œé™ä½æ„ŸçŸ¥å»¶è¿Ÿ
3. **ä¼šè¯éš”ç¦»**ï¼šæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹çš„KVç¼“å­˜
4. **ä¼˜é›…é™çº§**ï¼šè´Ÿè½½è¿‡é«˜æ—¶æ‹’ç»æ–°è¯·æ±‚

## æœ¬èŠ‚å°ç»“

æœ¬èŠ‚æ·±å…¥æ¢è®¨äº†å¤§æ¨¡å‹æ¨ç†ä¼˜åŒ–çš„æ ¸å¿ƒæŠ€æœ¯ï¼Œä»åŸç†åˆ°å®æˆ˜å…¨é¢æŒæ¡ï¼š

### æ ¸å¿ƒæŠ€æœ¯å›é¡¾

```mermaid
graph LR
    A[æ¨ç†ä¼˜åŒ–æŠ€æœ¯] --> B[KVç¼“å­˜<br/>é€Ÿåº¦æå‡10-50å€]
    A --> C[æ‰¹é‡æ¨ç†<br/>ååæå‡5-20å€]
    A --> D[é‡åŒ–å‹ç¼©<br/>å†…å­˜èŠ‚çœ50-75%]
    A --> E[æœåŠ¡æ¶æ„<br/>ç”Ÿäº§çº§éƒ¨ç½²]
    
    style B fill:#cfc,stroke:#333
    style C fill:#cfc,stroke:#333
    style D fill:#cfc,stroke:#333
    style E fill:#ffc,stroke:#333
```

### æŠ€æœ¯è¦ç‚¹æ€»ç»“

| æŠ€æœ¯ | æ ¸å¿ƒåŸç† | å…¸å‹æ•ˆæœ | é€‚ç”¨åœºæ™¯ |
|------|----------|----------|----------|
| **KVç¼“å­˜** | é¿å…é‡å¤è®¡ç®—å†å²token | åç»­è½®æ¬¡åŠ é€Ÿ7-50å€ | å¯¹è¯ã€ä»£ç è¡¥å…¨ |
| **æ‰¹é‡æ¨ç†** | å¤šè¯·æ±‚å¹¶è¡Œå¤„ç† | ååæå‡5-20å€ | é«˜å¹¶å‘æœåŠ¡ |
| **INT8é‡åŒ–** | ç”¨8ä½æ•´æ•°æ›¿ä»£32ä½æµ®ç‚¹ | æ¨¡å‹ç¼©å°4å€ã€åŠ é€Ÿ3-5å€ | è¾¹ç¼˜è®¾å¤‡ |
| **FP16ä¼˜åŒ–** | åŠç²¾åº¦æµ®ç‚¹è®¡ç®— | é€Ÿåº¦æå‡2-3å€ | GPUæ¨ç† |
| **åŠ¨æ€æ‰¹å¤„ç†** | æ™ºèƒ½æ‰“åŒ…è¯·æ±‚ | å»¶è¿Ÿç•¥å¢ã€ååå¤§å¢ | æ‰¹é‡ä»»åŠ¡ |

### å®æˆ˜ç»éªŒ

**ç”Ÿæ´»æ€»ç»“**ï¼šæ¨ç†ä¼˜åŒ–å°±åƒç»è¥ä¸€å®¶é¤å…ï¼š
- ğŸ³ **KVç¼“å­˜** = è®°ä½å®¢äººç‚¹è¿‡çš„èœï¼Œä¸é‡å¤åˆ¶ä½œ
- ğŸšŒ **æ‰¹é‡æ¨ç†** = å¤šä½å®¢äººçš„èœä¸€èµ·åšï¼Œæå‡æ•ˆç‡
- ğŸ“¦ **é‡åŒ–å‹ç¼©** = ç”¨ç®€ç§°ä»£æ›¿å†—é•¿èœåï¼ŒèŠ‚çœç©ºé—´
- ğŸª **æœåŠ¡æ¶æ„** = åˆç†åˆ†å·¥ï¼Œä»æ¥å•åˆ°ä¸Šèœæµæ°´çº¿ä½œä¸š

**å…³é”®æ•°æ®**ï¼ˆä»¥LLaMA-13Bä¸ºä¾‹ï¼‰ï¼š
- âš¡ å“åº”é€Ÿåº¦ï¼šä»2.5ç§’é™è‡³0.3ç§’ï¼ˆ**8å€æå‡**ï¼‰
- ğŸ’¾ å†…å­˜å ç”¨ï¼šä»24GBé™è‡³12GBï¼ˆ**èŠ‚çœ50%**ï¼‰
- ğŸš€ ååé‡ï¼šä»150æå‡è‡³1200 tokens/sï¼ˆ**8å€æå‡**ï¼‰
- ğŸ’° æˆæœ¬é™ä½ï¼šåŒæ ·ç¡¬ä»¶æ”¯æ’‘9å€æµé‡ï¼ˆ**é™ä½88%æˆæœ¬**ï¼‰

### æœ€ä½³å®è·µå»ºè®®

**é’ˆå¯¹ä¸åŒåœºæ™¯çš„æ¨èé…ç½®**ï¼š

```
ğŸ“± ç§»åŠ¨/è¾¹ç¼˜è®¾å¤‡ï¼š
   âœ… INT8é‡åŒ–ï¼ˆå¿…é¡»ï¼‰
   âœ… å°æ¨¡å‹ï¼ˆ7Bä»¥ä¸‹ï¼‰
   âœ… CPUä¼˜åŒ–
   
ğŸ’¬ å¯¹è¯ç³»ç»Ÿï¼š
   âœ… KVç¼“å­˜ï¼ˆå¿…é¡»ï¼‰
   âœ… FP16ç²¾åº¦
   âœ… å°æ‰¹æ¬¡å¤„ç†
   âœ… æµå¼è¿”å›
   
ğŸ“Š æ‰¹é‡å¤„ç†ï¼š
   âœ… å¤§æ‰¹æ¬¡ï¼ˆ32-128ï¼‰
   âœ… INT8é‡åŒ–
   âœ… åºåˆ—æ‰“åŒ…
   âœ… å¼‚æ­¥å¤„ç†
```

### ä¸‹ä¸€æ­¥å­¦ä¹ 

åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å®Œæˆ**å¤§æ¨¡å‹ä¼˜åŒ–çš„ç»¼åˆé¡¹ç›®**ï¼Œå°†LoRAå¾®è°ƒã€MoEæ¶æ„ã€æ¢¯åº¦æ£€æŸ¥ç‚¹ã€æ¨¡å‹å¹¶è¡Œå’Œæ¨ç†ä¼˜åŒ–ç­‰æŠ€æœ¯æ•´åˆåˆ°ä¸€ä¸ªå®Œæ•´çš„ç³»ç»Ÿä¸­ï¼Œæ„å»ºç”Ÿäº§çº§çš„å¤§æ¨¡å‹è®­ç»ƒå’Œéƒ¨ç½²æ–¹æ¡ˆã€‚

æŒæ¡è¿™äº›æŠ€æœ¯åï¼Œä½ å°†èƒ½å¤Ÿï¼š
- ğŸ¯ è®©7Bæ¨¡å‹åœ¨æ¶ˆè´¹çº§GPUä¸Šæµç•…è¿è¡Œ
- ğŸ¯ æ„å»ºæ”¯æ’‘åƒçº§å¹¶å‘çš„æ¨ç†æœåŠ¡
- ğŸ¯ å°†æ¨¡å‹å¤§å°å‹ç¼©75%çš„åŒæ—¶ä¿æŒç²¾åº¦
- ğŸ¯ è®¾è®¡ç¬¦åˆç”Ÿäº§ç¯å¢ƒè¦æ±‚çš„å®Œæ•´æ¶æ„