# 1.3 开发环境搭建与项目初始化

## 引言：工欲善其事，必先利其器

在前面的章节中，我们了解了Java在AI领域的优势和TinyAI项目的整体架构。现在是时候动手实践了！正如古语所说："工欲善其事，必先利其器"。在开始AI之旅之前，我们需要搭建一个高效、稳定的开发环境。

这不仅仅是安装几个软件那么简单，我们需要：
- 选择合适的Java版本和JVM参数
- 配置高效的IDE和开发工具
- 设置项目结构和依赖管理
- 建立代码质量保证机制
- 配置性能监控和调试工具

## 系统环境要求

### 硬件配置建议

#### 最低配置
```
CPU：Intel i5 或 AMD Ryzen 5（4核心）
内存：8GB RAM
存储：20GB 可用空间（SSD推荐）
```

#### 推荐配置
```
CPU：Intel i7/i9 或 AMD Ryzen 7/9（8核心以上）
内存：16GB RAM 或更多
存储：50GB 可用空间（NVMe SSD）
GPU：NVIDIA RTX系列（可选，用于后续GPU加速）
```

#### 企业级配置
```
CPU：Intel Xeon 或 AMD EPYC（16核心以上）
内存：32GB RAM 或更多
存储：100GB+ NVMe SSD
GPU：NVIDIA A100/V100 或多GPU配置
网络：万兆网络（分布式训练）
```

### 操作系统支持

TinyAI支持主流操作系统，但性能和开发体验有所差异：

#### Linux（推荐）
```bash
# Ubuntu 20.04 LTS 或更新版本
# CentOS 8 或更新版本
# 优势：最佳性能、丰富的开发工具、容器化支持
lsb_release -a
```

#### macOS
```bash
# macOS 11.0 Big Sur 或更新版本
# 优势：优秀的开发体验、Unix环境
sw_vers
```

#### Windows
```powershell
# Windows 10/11 或 Windows Server 2019/2022
# 优势：GUI工具丰富、企业环境兼容性好
Get-ComputerInfo | Select-Object WindowsProductName, WindowsVersion
```

## Java开发环境配置

### JDK安装与配置

#### 1. 选择JDK版本
TinyAI基于现代Java特性开发，推荐使用JDK 17或更高版本：

```bash
# 检查当前Java版本
java -version
javac -version

# 期望输出类似：
# openjdk version "17.0.8" 2023-07-18
# OpenJDK Runtime Environment (build 17.0.8+7-Ubuntu-1ubuntu120.04)
# OpenJDK 64-Bit Server VM (build 17.0.8+7-Ubuntu-1ubuntu120.04, mixed mode, sharing)
```

#### 2. JDK安装方法

**Ubuntu/Debian:**
```bash
# 安装OpenJDK 17
sudo apt update
sudo apt install openjdk-17-jdk openjdk-17-source

# 配置JAVA_HOME
echo 'export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64' >> ~/.bashrc
echo 'export PATH=$JAVA_HOME/bin:$PATH' >> ~/.bashrc
source ~/.bashrc
```

**macOS (使用Homebrew):**
```bash
# 安装Homebrew（如果还没有）
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 安装OpenJDK 17
brew install openjdk@17

# 配置环境变量
echo 'export JAVA_HOME=/opt/homebrew/opt/openjdk@17' >> ~/.zshrc
echo 'export PATH=$JAVA_HOME/bin:$PATH' >> ~/.zshrc
source ~/.zshrc
```

**Windows:**
```powershell
# 下载并安装OpenJDK 17
# 从 https://adoptium.net/ 下载安装包

# 配置环境变量（管理员权限）
[Environment]::SetEnvironmentVariable("JAVA_HOME", "C:\Program Files\Eclipse Adoptium\jdk-17.0.8.7-hotspot", "Machine")
[Environment]::SetEnvironmentVariable("PATH", $env:PATH + ";$env:JAVA_HOME\bin", "Machine")
```

#### 3. JVM性能调优参数

为AI计算创建专用的JVM配置：

```bash
# 创建JVM配置文件
cat > ~/.jvmrc << 'EOF'
# 内存配置
-Xms2g                    # 初始堆内存2GB
-Xmx8g                    # 最大堆内存8GB
-XX:NewRatio=1            # 新生代与老年代比例1:1
-XX:SurvivorRatio=8       # Eden与Survivor比例8:1:1

# GC配置（适合AI工作负载）
-XX:+UseG1GC              # 使用G1垃圾收集器
-XX:MaxGCPauseMillis=200  # 最大GC暂停时间200ms
-XX:G1HeapRegionSize=16m  # G1堆区域大小16MB

# 性能优化
-XX:+UseFMA               # 启用FMA指令
-XX:+UseAVX               # 启用AVX向量化指令
-XX:+AggressiveOpts       # 激进优化
-XX:+TieredCompilation    # 分层编译

# 调试和监控
-XX:+PrintGCDetails       # 打印GC详情
-XX:+PrintGCTimeStamps    # 打印GC时间戳
-Djava.awt.headless=true  # 无头模式（服务器环境）
EOF
```

### Maven配置

#### 1. Maven安装
```bash
# Ubuntu/Debian
sudo apt install maven

# macOS
brew install maven

# Windows (使用Chocolatey)
choco install maven

# 验证安装
mvn -version
```

#### 2. Maven性能优化配置

创建或修改 `~/.m2/settings.xml`：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 
                             http://maven.apache.org/xsd/settings-1.0.0.xsd">
    
    <!-- 本地仓库路径 -->
    <localRepository>~/.m2/repository</localRepository>
    
    <!-- 镜像配置（国内用户） -->
    <mirrors>
        <mirror>
            <id>aliyun-maven</id>
            <name>Aliyun Maven Central</name>
            <url>https://maven.aliyun.com/repository/public</url>
            <mirrorOf>central</mirrorOf>
        </mirror>
    </mirrors>
    
    <!-- 配置文件 -->
    <profiles>
        <profile>
            <id>development</id>
            <properties>
                <!-- 编译器配置 -->
                <maven.compiler.source>17</maven.compiler.source>
                <maven.compiler.target>17</maven.compiler.target>
                <maven.compiler.encoding>UTF-8</maven.compiler.encoding>
                
                <!-- JVM参数 -->
                <maven.test.jvmargs>-Xmx4g -XX:+UseG1GC</maven.test.jvmargs>
                
                <!-- 跳过某些检查以提高构建速度 -->
                <maven.javadoc.skip>true</maven.javadoc.skip>
                <maven.source.skip>true</maven.source.skip>
            </properties>
        </profile>
    </profiles>
    
    <!-- 激活开发配置 -->
    <activeProfiles>
        <activeProfile>development</activeProfile>
    </activeProfiles>
</settings>
```

## IDE配置与插件

### IntelliJ IDEA配置（推荐）

#### 1. IDEA安装与基础配置

```bash
# Ubuntu (使用snap)
sudo snap install intellij-idea-community --classic

# macOS
brew install --cask intellij-idea-ce

# 或者下载专业版（推荐用于企业开发）
brew install --cask intellij-idea
```

#### 2. 重要插件安装

通过 `File → Settings → Plugins` 安装以下插件：

```
必装插件：
├── Lombok              # 简化Java代码
├── Maven Helper        # Maven依赖分析
├── GitToolBox          # Git增强工具
├── SonarLint          # 代码质量检查
├── CheckStyle-IDEA    # 代码风格检查
├── Spotless           # 代码格式化
└── JProfiler          # 性能分析

AI开发相关：
├── CSV Plugin         # CSV数据文件支持
├── Database Tools     # 数据库连接工具
├── HTTP Client        # REST API测试
└── PlantUML          # UML图表支持

可选插件：
├── Rainbow Brackets   # 彩色括号
├── CodeGlance        # 代码缩略图
├── Key Promoter X    # 快捷键学习
└── Presentation Assistant # 演示辅助
```

#### 3. IDEA性能优化

编辑 `idea64.vmoptions` 文件（`Help → Edit Custom VM Options`）：

```
# 内存配置
-Xms2048m
-Xmx8192m
-XX:ReservedCodeCacheSize=1024m

# GC配置
-XX:+UseG1GC
-XX:MaxGCPauseMillis=200

# 性能优化
-XX:+UseFastAccessorMethods
-XX:+UnlockExperimentalVMOptions
-XX:+UseJVMCICompiler

# 系统属性
-Dsun.java2d.metal=true
-Didea.trust.all.projects=true
```

#### 4. 代码风格配置

导入TinyAI项目的代码风格配置：

```java
// File → Settings → Editor → Code Style → Java
// 导入以下配置文件：tinyai-codestyle.xml

/* 主要配置项：
 * - 缩进：4个空格
 * - 行长度：120字符
 * - import排序：java.*, javax.*, 其他, static
 * - 注释风格：JavaDoc标准
 */
```

### Visual Studio Code配置（轻量级选择）

#### 1. VSCode安装与Java扩展包

```bash
# 安装VSCode
# Ubuntu
sudo snap install code --classic

# macOS
brew install --cask visual-studio-code

# 安装Java扩展包
code --install-extension vscjava.vscode-java-pack
```

#### 2. 推荐扩展

```json
{
    "recommendations": [
        "vscjava.vscode-java-pack",
        "redhat.java",
        "vscjava.vscode-maven",
        "gabrielbb.vscode-lombok",
        "sonarsource.sonarlint-vscode",
        "ms-vscode.test-adapter-converter",
        "shengchen.vscode-checkstyle",
        "esbenp.prettier-vscode"
    ]
}
```

## TinyAI项目初始化

### 1. 获取项目源码

```bash
# 克隆项目
git clone https://github.com/leavesfly/TinyAI.git
cd TinyAI

# 查看项目结构
tree -L 2
```

期望的项目结构：
```
TinyAI/
├── README.md
├── pom.xml                           # 根POM文件
├── tinyai-deeplearning-ndarr/        # 多维数组模块
├── tinyai-deeplearning-func/         # 自动微分模块
├── tinyai-deeplearning-nnet/         # 神经网络模块
├── tinyai-deeplearning-ml/           # 机器学习模块
├── tinyai-deeplearning-rl/           # 强化学习模块
├── tinyai-deeplearning-case/         # 应用案例模块
├── tinyai-model-gpt/                 # GPT模型模块
├── tinyai-model-qwen/                # Qwen模型模块
├── tinyai-model-deepseek/            # DeepSeek模型模块
├── tinyai-model-lora/                # LoRA微调模块
├── tinyai-model-moe/                 # MoE模型模块
├── tinyai-agent-rag/                 # RAG智能体模块
├── tinyai-agent-multi/               # 多智能体模块
├── tinyai-agent-cursor/              # Cursor智能体模块
├── tinyai-agent-manus/               # 手稿智能体模块
├── tinyai-agent-research/            # 研究智能体模块
├── tinyai-agent-pattern/             # 模式智能体模块
├── tinyai-agent-context/             # 上下文智能体模块
├── tinyai-agent-evol/                # 进化智能体模块
├── book/                             # 本书内容
└── doc/                              # 项目文档
```

### 2. 构建项目

```bash
# 编译整个项目
mvn clean compile

# 运行测试
mvn test

# 打包项目
mvn package

# 安装到本地仓库
mvn install
```

### 3. IDE中导入项目

#### IntelliJ IDEA
```
1. File → Open
2. 选择TinyAI根目录
3. 选择"Import as Maven project"
4. 等待索引完成
5. 配置Project SDK为Java 17
```

#### Visual Studio Code
```
1. File → Open Folder
2. 选择TinyAI根目录
3. 安装推荐的扩展
4. 等待Java项目初始化完成
```

### 4. 验证环境配置

创建一个简单的测试程序：

```java
// src/test/java/org/tinyai/EnvironmentTest.java
package org.tinyai;

import org.junit.jupiter.api.Test;
import org.tinyai.ndarr.NdArray;
import org.tinyai.func.Variable;

import static org.junit.jupiter.api.Assertions.*;

public class EnvironmentTest {
    
    @Test
    public void testJavaVersion() {
        String version = System.getProperty("java.version");
        System.out.println("Java版本: " + version);
        assertTrue(version.startsWith("17") || version.startsWith("18") || 
                  version.startsWith("19") || version.startsWith("20") ||
                  version.startsWith("21"));
    }
    
    @Test
    public void testMemoryConfiguration() {
        Runtime runtime = Runtime.getRuntime();
        long maxMemory = runtime.maxMemory() / 1024 / 1024; // MB
        System.out.println("最大堆内存: " + maxMemory + "MB");
        assertTrue(maxMemory >= 1024, "至少需要1GB堆内存");
    }
    
    @Test
    public void testNdArrayCreation() {
        // 测试NdArray基本功能
        float[][] data = {{1.0f, 2.0f}, {3.0f, 4.0f}};
        NdArray array = NdArray.create(data);
        
        assertNotNull(array);
        assertEquals(2, array.shape().ndim());
        assertEquals(4, array.size());
        
        System.out.println("NdArray创建成功: " + array);
    }
    
    @Test
    public void testVariableCreation() {
        // 测试Variable基本功能
        NdArray data = NdArray.create(new float[]{1.0f, 2.0f, 3.0f});
        Variable var = Variable.of(data, true);
        
        assertNotNull(var);
        assertTrue(var.requiresGrad());
        
        System.out.println("Variable创建成功: " + var);
    }
    
    @Test
    public void testBasicComputation() {
        // 测试基本计算
        Variable a = Variable.of(NdArray.create(new float[]{1.0f, 2.0f}), true);
        Variable b = Variable.of(NdArray.create(new float[]{3.0f, 4.0f}), true);
        
        Variable c = a.add(b);
        c.backward();
        
        assertNotNull(a.getGrad());
        assertNotNull(b.getGrad());
        
        System.out.println("基本计算测试通过");
        System.out.println("a + b = " + c);
        System.out.println("a.grad = " + a.getGrad());
        System.out.println("b.grad = " + b.getGrad());
    }
}
```

运行测试：
```bash
mvn test -Dtest=EnvironmentTest
```

期望输出：
```
Tests run: 5, Failures: 0, Errors: 0, Skipped: 0

Java版本: 17.0.8
最大堆内存: 8192MB
NdArray创建成功: NdArray{shape=[2, 2], data=[1.0, 2.0, 3.0, 4.0]}
Variable创建成功: Variable{data=NdArray{shape=[3], data=[1.0, 2.0, 3.0]}, requiresGrad=true}
基本计算测试通过
a + b = Variable{data=NdArray{shape=[2], data=[4.0, 6.0]}, requiresGrad=true}
a.grad = NdArray{shape=[2], data=[1.0, 1.0]}
b.grad = NdArray{shape=[2], data=[1.0, 1.0]}
```

## 开发工具链配置

### 版本控制配置

#### Git配置
```bash
# 基础配置
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"
git config --global init.defaultBranch main

# 提高性能
git config --global core.preloadindex true
git config --global core.fscache true
git config --global gc.auto 256

# 配置.gitignore
cat > .gitignore << 'EOF'
# IDE
.idea/
*.iml
.vscode/
.settings/

# Maven
target/
pom.xml.tag
pom.xml.releaseBackup
pom.xml.versionsBackup

# Java
*.class
*.jar
*.war
*.nar
*.ear
*.zip
*.tar.gz
*.rar
hs_err_pid*
replay_pid*

# 临时文件
*.tmp
*.temp
*.log
*.swp
*.swo
*~

# OS
.DS_Store
.DS_Store?
._*
.Spotlight-V100
.Trashes
ehthumbs.db
Thumbs.db

# AI相关
datasets/
models/
checkpoints/
runs/
logs/
*.h5
*.pkl
*.npy
*.npz
EOF
```

### 代码质量工具

#### 1. SpotBugs配置
在根POM中添加：

```xml
<plugin>
    <groupId>com.github.spotbugs</groupId>
    <artifactId>spotbugs-maven-plugin</artifactId>
    <version>4.7.3.6</version>
    <configuration>
        <effort>Max</effort>
        <threshold>Low</threshold>
        <xmlOutput>true</xmlOutput>
        <excludeFilterFile>spotbugs-exclude.xml</excludeFilterFile>
    </configuration>
</plugin>
```

#### 2. CheckStyle配置
```xml
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-checkstyle-plugin</artifactId>
    <version>3.3.0</version>
    <configuration>
        <configLocation>checkstyle.xml</configLocation>
        <encoding>UTF-8</encoding>
        <consoleOutput>true</consoleOutput>
        <failsOnError>true</failsOnError>
    </configuration>
</plugin>
```

### 性能监控工具

#### 1. JProfiler集成
```bash
# 下载并安装JProfiler
# 在IDEA中安装JProfiler插件

# 配置JVM参数启动性能监控
export JPROFILER_AGENT="-agentpath:/path/to/jprofiler/bin/linux-x64/libjprofilerti.so=port=8849"
java $JPROFILER_AGENT -jar your-app.jar
```

#### 2. 内置性能监控
```java
public class PerformanceMonitor {
    private static final Map<String, Long> timers = new ConcurrentHashMap<>();
    private static final Map<String, AtomicLong> counters = new ConcurrentHashMap<>();
    
    public static void startTimer(String name) {
        timers.put(name, System.nanoTime());
    }
    
    public static long stopTimer(String name) {
        Long start = timers.remove(name);
        if (start == null) return -1;
        long elapsed = System.nanoTime() - start;
        System.out.printf("%s耗时: %.2fms%n", name, elapsed / 1_000_000.0);
        return elapsed;
    }
    
    public static void incrementCounter(String name) {
        counters.computeIfAbsent(name, k -> new AtomicLong(0)).incrementAndGet();
    }
    
    public static void printStats() {
        System.out.println("=== 性能统计 ===");
        counters.forEach((name, count) -> 
            System.out.printf("%s: %d%n", name, count.get()));
    }
}
```

## 故障排除指南

### 常见问题及解决方案

#### 1. 内存不足错误
```
错误信息：java.lang.OutOfMemoryError: Java heap space
解决方案：
1. 增加堆内存大小：-Xmx8g
2. 优化GC配置：-XX:+UseG1GC
3. 使用内存分析工具检查内存泄漏
```

#### 2. 编译错误
```
错误信息：package org.tinyai.ndarr does not exist
解决方案：
1. 重新导入Maven项目
2. 刷新依赖：mvn dependency:resolve
3. 清理重建：mvn clean compile
```

#### 3. 测试失败
```
错误信息：Test failures
解决方案：
1. 检查Java版本是否符合要求
2. 验证依赖项是否正确安装
3. 查看详细错误日志
```

#### 4. IDE性能问题
```
现象：IDE响应缓慢
解决方案：
1. 增加IDE内存配置
2. 禁用不必要的插件
3. 优化索引设置
4. 排除大型文件夹（如datasets/）
```

### 性能基准测试

创建基准测试来验证环境性能：

```java
@BenchmarkMode(Mode.AverageTime)
@OutputTimeUnit(TimeUnit.MILLISECONDS)
@State(Scope.Benchmark)
public class EnvironmentBenchmark {
    
    private NdArray largeMatrix;
    
    @Setup
    public void setup() {
        // 创建1000x1000的矩阵
        largeMatrix = NdArray.randn(1000, 1000);
    }
    
    @Benchmark
    public NdArray matrixMultiplication() {
        return largeMatrix.matmul(largeMatrix);
    }
    
    @Benchmark
    public NdArray elementWiseOperations() {
        return largeMatrix.add(1.0f).multiply(2.0f).subtract(0.5f);
    }
    
    public static void main(String[] args) throws Exception {
        Options opt = new OptionsBuilder()
            .include(EnvironmentBenchmark.class.getSimpleName())
            .forks(1)
            .warmupIterations(3)
            .measurementIterations(5)
            .build();
        new Runner(opt).run();
    }
}
```

## 小节总结

### 核心要点
1. **环境配置**：正确配置Java 17+、Maven、IDE是高效开发的基础
2. **性能优化**：通过JVM参数调优、IDE配置优化提升开发体验
3. **项目结构**：理解TinyAI的模块化架构和依赖关系
4. **质量保证**：配置代码质量工具和性能监控机制

### 开发最佳实践
- **内存配置**：为AI工作负载分配足够的堆内存
- **GC优化**：使用G1GC减少GC暂停时间
- **IDE优化**：合理配置插件和性能参数
- **监控工具**：建立完善的性能监控体系

### 验证清单
在继续后续章节之前，请确认：
- [ ] Java 17+正确安装并配置
- [ ] Maven构建成功
- [ ] IDE能正常打开项目
- [ ] 环境测试全部通过
- [ ] 基准测试性能符合预期

## 思考题

1. **配置优化题**：如果你的机器只有4GB内存，应该如何调整JVM参数配置？

2. **故障诊断题**：当遇到`java.lang.OutOfMemoryError: GC overhead limit exceeded`错误时，你会如何分析和解决？

3. **性能调优题**：对于AI训练任务，G1GC和Parallel GC哪个更适合？为什么？

4. **工具选择题**：在团队开发中，你会如何选择和配置代码质量检查工具？

## 拓展阅读

- **JVM性能调优**：《深入理解Java虚拟机》
- **Maven实战**：《Maven实战》
- **IDE最佳实践**：IntelliJ IDEA官方文档
- **性能分析工具**：JProfiler用户手册

---

**本小节完**：下一小节我们将运行第一个AI程序——手写数字识别，验证我们的开发环境配置。