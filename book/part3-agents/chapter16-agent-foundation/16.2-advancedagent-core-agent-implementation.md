# 16.2 AdvancedAgent：核心智能体实现

> **设计思想**：实现一个功能完整、可扩展的智能体核心框架

## 本节概述

在上一节中，我们学习了智能体的基本概念和架构设计原则。本节将基于这些理论知识，实现一个功能完整的AdvancedAgent核心框架。该框架将包含智能体的基本组件、状态管理、生命周期控制等核心功能，为后续的高级功能实现奠定基础。

## 学习目标

完成本节学习后，你将：

- ✅ **掌握智能体核心类设计**：理解Agent类的基本结构和设计模式
- ✅ **实现状态管理机制**：掌握智能体状态的管理和更新方法
- ✅ **掌握生命周期控制**：理解智能体的初始化、运行和终止过程
- ✅ **实现输入处理机制**：学会处理各种类型的输入数据
- ✅ **掌握输出生成方法**：理解智能体响应的生成和格式化
- ✅ **具备错误处理能力**：掌握异常处理和错误恢复机制

## AdvancedAgent核心类设计

### 基础架构

```java
public abstract class AdvancedAgent {
    protected String agentId;
    protected String name;
    protected AgentState currentState;
    protected AgentContext context;
    protected List<AgentComponent> components;
    protected EventBus eventBus;
    protected Logger logger;
    
    public AdvancedAgent(String agentId, String name) {
        this.agentId = agentId;
        this.name = name;
        this.currentState = AgentState.INITIALIZING;
        this.context = new AgentContext();
        this.components = new ArrayList<>();
        this.eventBus = new EventBus();
        this.logger = LoggerFactory.getLogger(this.getClass());
    }
    
    // 抽象方法，子类必须实现
    public abstract AgentResponse processRequest(AgentRequest request);
    
    // 模板方法，定义标准流程
    public final AgentResponse handleRequest(AgentRequest request) {
        try {
            // 验证输入
            validateRequest(request);
            
            // 更新状态
            updateState(AgentState.PROCESSING);
            
            // 处理请求
            AgentResponse response = processRequest(request);
            
            // 记录日志
            logRequestResponse(request, response);
            
            // 更新状态
            updateState(AgentState.READY);
            
            return response;
        } catch (Exception e) {
            handleError(e, request);
            return createErrorResponse(e);
        }
    }
    
    protected void validateRequest(AgentRequest request) throws InvalidRequestException {
        if (request == null) {
            throw new InvalidRequestException("Request cannot be null");
        }
        
        if (request.getInput() == null || request.getInput().trim().isEmpty()) {
            throw new InvalidRequestException("Input cannot be empty");
        }
    }
    
    protected void updateState(AgentState newState) {
        AgentState oldState = this.currentState;
        this.currentState = newState;
        
        // 发布状态变更事件
        eventBus.publish(new StateChangeEvent(this, oldState, newState));
        
        logger.info("Agent {} state changed from {} to {}", 
                   name, oldState, newState);
    }
    
    protected void logRequestResponse(AgentRequest request, AgentResponse response) {
        logger.debug("Agent {} processed request: {} -> {}", 
                    name, request.getInput(), response.getOutput());
    }
    
    protected void handleError(Exception e, AgentRequest request) {
        logger.error("Agent {} encountered error processing request: {}", 
                    name, request.getInput(), e);
        
        // 发布错误事件
        eventBus.publish(new ErrorEvent(this, e, request));
    }
    
    protected AgentResponse createErrorResponse(Exception e) {
        return new AgentResponse(
            "Sorry, I encountered an error: " + e.getMessage(),
            ResponseType.ERROR,
            System.currentTimeMillis()
        );
    }
}
```

### Agent状态管理

```java
public enum AgentState {
    INITIALIZING("初始化"),
    READY("就绪"),
    PROCESSING("处理中"),
    BUSY("忙碌"),
    ERROR("错误"),
    TERMINATED("终止");
    
    private final String description;
    
    AgentState(String description) {
        this.description = description;
    }
    
    public String getDescription() {
        return description;
    }
}

public class AgentContext {
    private Map<String, Object> attributes;
    private List<Interaction> interactionHistory;
    private long startTime;
    private long lastActivityTime;
    
    public AgentContext() {
        this.attributes = new ConcurrentHashMap<>();
        this.interactionHistory = new ArrayList<>();
        this.startTime = System.currentTimeMillis();
        this.lastActivityTime = startTime;
    }
    
    public void setAttribute(String key, Object value) {
        attributes.put(key, value);
        updateActivityTime();
    }
    
    public <T> T getAttribute(String key, Class<T> type) {
        Object value = attributes.get(key);
        if (value != null && type.isInstance(value)) {
            return type.cast(value);
        }
        return null;
    }
    
    public void addInteraction(Interaction interaction) {
        interactionHistory.add(interaction);
        updateActivityTime();
    }
    
    public List<Interaction> getRecentInteractions(int count) {
        int size = interactionHistory.size();
        int fromIndex = Math.max(0, size - count);
        return new ArrayList<>(interactionHistory.subList(fromIndex, size));
    }
    
    private void updateActivityTime() {
        this.lastActivityTime = System.currentTimeMillis();
    }
    
    public long getUptime() {
        return System.currentTimeMillis() - startTime;
    }
    
    public long getIdleTime() {
        return System.currentTimeMillis() - lastActivityTime;
    }
}
```

### 请求和响应模型

```java
public class AgentRequest {
    private String requestId;
    private String sessionId;
    private String input;
    private Map<String, Object> metadata;
    private long timestamp;
    private RequestType type;
    
    public AgentRequest(String input) {
        this.requestId = UUID.randomUUID().toString();
        this.input = input;
        this.timestamp = System.currentTimeMillis();
        this.metadata = new HashMap<>();
        this.type = RequestType.TEXT;
    }
    
    // Getters and setters
    public String getRequestId() { return requestId; }
    public String getSessionId() { return sessionId; }
    public void setSessionId(String sessionId) { this.sessionId = sessionId; }
    public String getInput() { return input; }
    public Map<String, Object> getMetadata() { return metadata; }
    public long getTimestamp() { return timestamp; }
    public RequestType getType() { return type; }
    public void setType(RequestType type) { this.type = type; }
    
    public void addMetadata(String key, Object value) {
        this.metadata.put(key, value);
    }
}

public class AgentResponse {
    private String output;
    private ResponseType type;
    private long timestamp;
    private Map<String, Object> metadata;
    private List<ToolCall> toolCalls;
    
    public AgentResponse(String output) {
        this(output, ResponseType.TEXT, System.currentTimeMillis());
    }
    
    public AgentResponse(String output, ResponseType type, long timestamp) {
        this.output = output;
        this.type = type;
        this.timestamp = timestamp;
        this.metadata = new HashMap<>();
        this.toolCalls = new ArrayList<>();
    }
    
    // Getters and setters
    public String getOutput() { return output; }
    public ResponseType getType() { return type; }
    public long getTimestamp() { return timestamp; }
    public Map<String, Object> getMetadata() { return metadata; }
    public List<ToolCall> getToolCalls() { return toolCalls; }
    
    public void addMetadata(String key, Object value) {
        this.metadata.put(key, value);
    }
    
    public void addToolCall(ToolCall toolCall) {
        this.toolCalls.add(toolCall);
    }
}

public enum RequestType {
    TEXT, VOICE, IMAGE, VIDEO, FILE
}

public enum ResponseType {
    TEXT, VOICE, IMAGE, JSON, TOOL_CALL, ERROR
}
```

## 核心组件实现

### 组件管理器

```java
public abstract class AgentComponent {
    protected String componentName;
    protected boolean enabled;
    protected AgentContext context;
    protected EventBus eventBus;
    
    public AgentComponent(String componentName) {
        this.componentName = componentName;
        this.enabled = true;
    }
    
    public abstract void initialize(AgentContext context, EventBus eventBus);
    public abstract void process(AgentRequest request, AgentResponse response);
    public abstract void cleanup();
    
    public String getComponentName() {
        return componentName;
    }
    
    public boolean isEnabled() {
        return enabled;
    }
    
    public void setEnabled(boolean enabled) {
        this.enabled = enabled;
    }
    
    protected void publishEvent(Event event) {
        if (eventBus != null) {
            eventBus.publish(event);
        }
    }
}

public class ComponentManager {
    private List<AgentComponent> components;
    private Map<String, AgentComponent> componentMap;
    
    public ComponentManager() {
        this.components = new ArrayList<>();
        this.componentMap = new HashMap<>();
    }
    
    public void registerComponent(AgentComponent component) {
        components.add(component);
        componentMap.put(component.getComponentName(), component);
    }
    
    public void unregisterComponent(String componentName) {
        AgentComponent component = componentMap.remove(componentName);
        if (component != null) {
            components.remove(component);
            component.cleanup();
        }
    }
    
    public <T extends AgentComponent> T getComponent(String name, Class<T> type) {
        AgentComponent component = componentMap.get(name);
        if (component != null && type.isInstance(component)) {
            return type.cast(component);
        }
        return null;
    }
    
    public void initializeComponents(AgentContext context, EventBus eventBus) {
        for (AgentComponent component : components) {
            try {
                component.initialize(context, eventBus);
            } catch (Exception e) {
                // 记录初始化错误，但不中断其他组件初始化
                LoggerFactory.getLogger(ComponentManager.class)
                    .error("Failed to initialize component: " + component.getComponentName(), e);
            }
        }
    }
    
    public void processComponents(AgentRequest request, AgentResponse response) {
        for (AgentComponent component : components) {
            if (component.isEnabled()) {
                try {
                    component.process(request, response);
                } catch (Exception e) {
                    // 记录处理错误，但继续处理其他组件
                    LoggerFactory.getLogger(ComponentManager.class)
                        .error("Component " + component.getComponentName() + " failed to process request", e);
                }
            }
        }
    }
}
```

### 事件总线

```java
public class EventBus {
    private Map<String, List<EventListener>> listeners;
    private ExecutorService executorService;
    
    public EventBus() {
        this.listeners = new ConcurrentHashMap<>();
        this.executorService = Executors.newCachedThreadPool();
    }
    
    public void subscribe(String eventType, EventListener listener) {
        listeners.computeIfAbsent(eventType, k -> new CopyOnWriteArrayList<>()).add(listener);
    }
    
    public void unsubscribe(String eventType, EventListener listener) {
        List<EventListener> eventListeners = listeners.get(eventType);
        if (eventListeners != null) {
            eventListeners.remove(listener);
        }
    }
    
    public void publish(Event event) {
        publish(event, false);
    }
    
    public void publishAsync(Event event) {
        publish(event, true);
    }
    
    private void publish(Event event, boolean async) {
        List<EventListener> eventListeners = listeners.get(event.getType());
        if (eventListeners != null) {
            for (EventListener listener : eventListeners) {
                if (async) {
                    executorService.submit(() -> notifyListener(listener, event));
                } else {
                    notifyListener(listener, event);
                }
            }
        }
    }
    
    private void notifyListener(EventListener listener, Event event) {
        try {
            listener.onEvent(event);
        } catch (Exception e) {
            // 记录监听器错误，但不中断其他监听器
            LoggerFactory.getLogger(EventBus.class)
                .error("Event listener failed to handle event: " + event.getType(), e);
        }
    }
}

public interface EventListener {
    void onEvent(Event event);
}

public abstract class Event {
    protected String type;
    protected long timestamp;
    protected Object source;
    
    public Event(String type, Object source) {
        this.type = type;
        this.timestamp = System.currentTimeMillis();
        this.source = source;
    }
    
    public String getType() { return type; }
    public long getTimestamp() { return timestamp; }
    public Object getSource() { return source; }
}

public class StateChangeEvent extends Event {
    private AgentState oldState;
    private AgentState newState;
    
    public StateChangeEvent(Object source, AgentState oldState, AgentState newState) {
        super("STATE_CHANGE", source);
        this.oldState = oldState;
        this.newState = newState;
    }
    
    public AgentState getOldState() { return oldState; }
    public AgentState getNewState() { return newState; }
}
```

## 完整的AdvancedAgent实现

```java
public class AdvancedAgentImpl extends AdvancedAgent {
    private ComponentManager componentManager;
    private Configuration configuration;
    private HealthMonitor healthMonitor;
    
    public AdvancedAgentImpl(String agentId, String name, Configuration config) {
        super(agentId, name);
        this.configuration = config;
        this.componentManager = new ComponentManager();
        this.healthMonitor = new HealthMonitor(this);
        
        // 初始化智能体
        initialize();
    }
    
    private void initialize() {
        try {
            updateState(AgentState.INITIALIZING);
            
            // 初始化组件管理器
            componentManager.initializeComponents(context, eventBus);
            
            // 启动健康监控
            healthMonitor.start();
            
            updateState(AgentState.READY);
            
            logger.info("Agent {} initialized successfully", name);
        } catch (Exception e) {
            logger.error("Failed to initialize agent " + name, e);
            updateState(AgentState.ERROR);
            throw new AgentInitializationException("Failed to initialize agent", e);
        }
    }
    
    @Override
    public AgentResponse processRequest(AgentRequest request) {
        // 创建初始响应
        AgentResponse response = new AgentResponse("");
        
        // 记录交互历史
        context.addInteraction(new Interaction(request, response));
        
        // 通过组件处理请求
        componentManager.processComponents(request, response);
        
        // 如果没有组件产生输出，使用默认处理
        if (response.getOutput().isEmpty() && response.getToolCalls().isEmpty()) {
            response.setOutput(generateDefaultResponse(request));
        }
        
        return response;
    }
    
    private String generateDefaultResponse(AgentRequest request) {
        // 简单的默认响应生成逻辑
        return "I received your message: " + request.getInput();
    }
    
    public void addComponent(AgentComponent component) {
        componentManager.registerComponent(component);
    }
    
    public void removeComponent(String componentName) {
        componentManager.unregisterComponent(componentName);
    }
    
    public <T extends AgentComponent> T getComponent(String name, Class<T> type) {
        return componentManager.getComponent(name, type);
    }
    
    public AgentHealth getHealthStatus() {
        return healthMonitor.getHealthStatus();
    }
    
    public void shutdown() {
        try {
            updateState(AgentState.TERMINATED);
            
            // 停止健康监控
            healthMonitor.stop();
            
            // 清理组件
            for (AgentComponent component : components) {
                try {
                    component.cleanup();
                } catch (Exception e) {
                    logger.warn("Error cleaning up component: " + component.getComponentName(), e);
                }
            }
            
            logger.info("Agent {} shutdown successfully", name);
        } catch (Exception e) {
            logger.error("Error during agent shutdown", e);
        }
    }
}
```

## 配置和健康监控

### 配置管理

```java
public class Configuration {
    private Map<String, Object> properties;
    
    public Configuration() {
        this.properties = new ConcurrentHashMap<>();
    }
    
    public void setProperty(String key, Object value) {
        properties.put(key, value);
    }
    
    @SuppressWarnings("unchecked")
    public <T> T getProperty(String key, Class<T> type) {
        Object value = properties.get(key);
        if (value != null && type.isInstance(value)) {
            return (T) value;
        }
        return null;
    }
    
    public <T> T getProperty(String key, T defaultValue) {
        T value = (T) properties.get(key);
        return value != null ? value : defaultValue;
    }
    
    public static Configuration fromFile(String configFile) throws IOException {
        // 从文件加载配置
        Configuration config = new Configuration();
        // 实现配置文件解析逻辑
        return config;
    }
}
```

### 健康监控

```java
public class HealthMonitor {
    private AdvancedAgent agent;
    private ScheduledExecutorService scheduler;
    private AtomicReference<AgentHealth> healthStatus;
    private List<HealthCheck> healthChecks;
    
    public HealthMonitor(AdvancedAgent agent) {
        this.agent = agent;
        this.scheduler = Executors.newScheduledThreadPool(1);
        this.healthStatus = new AtomicReference<>(new AgentHealth(AgentHealth.Status.HEALTHY));
        this.healthChecks = new ArrayList<>();
        
        // 添加默认健康检查
        addDefaultHealthChecks();
    }
    
    private void addDefaultHealthChecks() {
        healthChecks.add(new MemoryHealthCheck());
        healthChecks.add(new ThreadHealthCheck());
        healthChecks.add(new ComponentHealthCheck(agent));
    }
    
    public void start() {
        scheduler.scheduleAtFixedRate(this::performHealthCheck, 0, 30, TimeUnit.SECONDS);
    }
    
    public void stop() {
        scheduler.shutdown();
    }
    
    private void performHealthCheck() {
        AgentHealth.Builder builder = AgentHealth.builder();
        builder.timestamp(System.currentTimeMillis());
        
        boolean isHealthy = true;
        List<String> issues = new ArrayList<>();
        
        for (HealthCheck check : healthChecks) {
            try {
                HealthCheck.Result result = check.check();
                if (!result.isHealthy()) {
                    isHealthy = false;
                    issues.addAll(result.getIssues());
                }
            } catch (Exception e) {
                isHealthy = false;
                issues.add("Health check failed: " + check.getName() + " - " + e.getMessage());
            }
        }
        
        AgentHealth.Status status = isHealthy ? AgentHealth.Status.HEALTHY : AgentHealth.Status.UNHEALTHY;
        builder.status(status);
        builder.issues(issues);
        
        healthStatus.set(builder.build());
    }
    
    public AgentHealth getHealthStatus() {
        return healthStatus.get();
    }
}

public class AgentHealth {
    private Status status;
    private long timestamp;
    private List<String> issues;
    
    public AgentHealth(Status status) {
        this.status = status;
        this.timestamp = System.currentTimeMillis();
        this.issues = new ArrayList<>();
    }
    
    // Getters
    public Status getStatus() { return status; }
    public long getTimestamp() { return timestamp; }
    public List<String> getIssues() { return issues; }
    
    public enum Status {
        HEALTHY, UNHEALTHY, DEGRADED
    }
    
    public static Builder builder() {
        return new Builder();
    }
    
    public static class Builder {
        private Status status;
        private long timestamp;
        private List<String> issues = new ArrayList<>();
        
        public Builder status(Status status) {
            this.status = status;
            return this;
        }
        
        public Builder timestamp(long timestamp) {
            this.timestamp = timestamp;
            return this;
        }
        
        public Builder issues(List<String> issues) {
            this.issues = issues;
            return this;
        }
        
        public AgentHealth build() {
            AgentHealth health = new AgentHealth(status);
            // 设置其他属性
            return health;
        }
    }
}
```

## 使用示例

```java
public class AgentUsageExample {
    public static void main(String[] args) {
        try {
            // 创建配置
            Configuration config = new Configuration();
            config.setProperty("model.name", "gpt-3.5-turbo");
            config.setProperty("max.tokens", 1000);
            
            // 创建智能体
            AdvancedAgent agent = new AdvancedAgentImpl("agent-001", "MyAgent", config);
            
            // 添加组件
            agent.addComponent(new LanguageProcessingComponent());
            agent.addComponent(new ToolExecutionComponent());
            
            // 处理请求
            AgentRequest request = new AgentRequest("Hello, how are you?");
            request.setSessionId("session-123");
            
            AgentResponse response = agent.handleRequest(request);
            
            System.out.println("Response: " + response.getOutput());
            
            // 检查健康状态
            AgentHealth health = ((AdvancedAgentImpl) agent).getHealthStatus();
            System.out.println("Health: " + health.getStatus());
            
            // 关闭智能体
            ((AdvancedAgentImpl) agent).shutdown();
            
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

## 本节小结

本节我们实现了一个功能完整的AdvancedAgent核心框架，包括：

1. **核心类设计**：实现了AdvancedAgent抽象基类和完整的类层次结构
2. **状态管理**：设计了智能体状态管理和上下文管理机制
3. **组件系统**：构建了可扩展的组件管理和事件总线系统
4. **配置管理**：实现了灵活的配置管理机制
5. **健康监控**：建立了智能体健康状态监控系统
6. **错误处理**：设计了完善的异常处理和错误恢复机制

通过本节的实现，我们建立了一个坚实的基础框架，为后续章节中记忆系统、工具调用、LLM集成等高级功能的实现做好了准备。

在下一节中，我们将学习记忆系统的设计与实现，掌握工作记忆、情节记忆和语义记忆的构建方法。